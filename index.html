<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AkıllıMarket</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Akıllı alışveriş asistanınız">
    <meta name="theme-color" content="#6366F1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="AkıllıMarket">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #6366F1;
            --primary-dark: #4F46E5;
            --secondary-color: #F59E0B;
            --accent-color: #10B981;
            --background-color: #FAFBFC;
            --background-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --text-color: #1E293B;
            --text-light: #64748B;
            --card-background: #FFFFFF;
            --border-color: #E2E8F0;
            --shadow: 0 10px 25px rgba(99, 102, 241, 0.1);
            --shadow-hover: 0 20px 40px rgba(99, 102, 241, 0.2);
            --danger-color: #EF4444; /* Yeni: Tehlike rengi */
            --danger-dark: #DC2626;  /* Yeni: Tehlike koyu rengi */
        }

        [data-theme="dark"] {
            --primary-color: #818CF8;
            --primary-dark: #6366F1;
            --secondary-color: #FBBF24;
            --accent-color: #34D399;
            --background-color: #0F172A;
            --background-gradient: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 100%);
            --text-color: #F1F5F9;
            --text-light: #94A3B8;
            --card-background: #1E293B;
            --border-color: #334155;
            --shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            --shadow-hover: 0 20px 40px rgba(0, 0, 0, 0.4);
            --danger-color: #F87171;
            --danger-dark: #EF4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--background-color);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            color: var(--text-color);
            transition: all 0.4s ease;
            font-weight: 400;
            line-height: 1.6;
            letter-spacing: -0.01em;
            /* Mobil cihazlarda daha iyi okunabilirlik için varsayılan font boyutunu ayarlayın */
            font-size: 16px; 
        }

        body.large-text {
            font-size: 1.3em !important;
        }

        body.large-text .card-title {
            font-size: 28px !important;
        }

        body.high-contrast {
            filter: contrast(200%) brightness(1.2) !important;
        }

        body.high-contrast .card {
            border: 3px solid var(--text-color) !important;
            box-shadow: 0 0 20px rgba(0,0,0,0.6) !important;
        }

        .app-container {
            max-width: 420px;
            margin: 0 auto;
            min-height: 100vh;
            background: var(--background-color);
            /* Mobil cihazlarda kenar boşluğu bırakmak için padding ekleyin */
            padding-bottom: 80px; /* bottom-nav yüksekliği kadar */
        }

        /* Login */
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: var(--background-gradient);
            color: white;
            padding: 20px;
            text-align: center; /* Logo ve metinleri ortala */
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 24px;
            background: rgba(255, 255, 255, 0.15);
            padding: 48px 36px;
            border-radius: 28px;
            backdrop-filter: blur(20px);
            width: 100%;
            max-width: 340px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }
        
        .login-logo-container {
            margin-bottom: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px; /* Logo ve başlık arasına boşluk */
        }

        .login-logo {
            font-size: 80px; /* Emoji boyutu */
            line-height: 1; /* Satır yüksekliği */
            margin-bottom: 10px;
        }


        .login-form h1 {
            font-size: 36px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 8px; /* Logoyla arasına boşluk */
            line-height: 1.2;
        }

        .login-form p {
            text-align: center;
            opacity: 0.9;
            font-weight: 400;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .login-form input {
            padding: 18px 24px;
            border: none;
            border-radius: 18px;
            font-size: 16px;
            font-weight: 500;
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            font-family: 'Inter', sans-serif;
            /* Mobil klavyelerde zoom olmaması için minimum font boyutu */
            min-height: 52px; /* Dokunma hedefi için minimum yükseklik */
        }

        .login-form button {
            padding: 18px;
            border: none;
            border-radius: 18px;
            font-size: 16px;
            font-weight: 600;
            background: linear-gradient(135deg, #6366F1 0%, #4F46E5 100%);
            color: white;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
            min-height: 52px; /* Dokunma hedefi için minimum yükseklik */
        }

        .login-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(99, 102, 241, 0.4);
        }

        /* Header */
        .app-header {
            background: var(--background-gradient);
            color: white;
            padding: 28px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            backdrop-filter: blur(20px);
        }

        .app-header h1 {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.02em;
            /* Mobil için font boyutunu küçült */
            font-size: 24px;
            display: flex; /* Logo ve başlık için flex */
            align-items: center;
            gap: 10px; /* Logo ve metin arasına boşluk */
        }

        .header-logo {
            font-size: 32px; /* Emoji boyutu */
            line-height: 1; /* Satır yüksekliği */
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            /* Mobil için font boyutunu küçült */
            font-size: 14px;
        }

        .user-info button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 14px;
            cursor: pointer;
            font-weight: 500;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
            /* Dokunma hedefi için minimum boyut */
            min-width: 44px;
            min-height: 44px;
        }

        .user-info button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        /* Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 420px;
            background: var(--card-background);
            display: flex;
            justify-content: space-around;
            padding: 12px 0; /* Daha az padding mobil için */
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -10px 25px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(20px);
            z-index: 100; /* Diğer elementlerin üzerinde olduğundan emin olun */
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px; /* Daha az gap mobil için */
            cursor: pointer;
            padding: 8px 12px; /* Daha az padding mobil için */
            border-radius: 16px;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 11px; /* Daha küçük font boyutu mobil için */
            color: var(--text-light);
            /* Dokunma hedefi için yeterli alan sağlayın */
            min-width: 60px;
            min-height: 60px;
            justify-content: center;
        }

        .nav-item.active {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary-color);
            transform: translateY(-2px);
        }

        .nav-icon {
            font-size: 20px; /* Daha küçük ikon boyutu mobil için */
            transition: all 0.3s ease;
        }

        .nav-item.active .nav-icon {
            transform: scale(1.1);
        }

        /* Main Content */
        .main-content {
            padding: 24px 20px;
            padding-bottom: 120px; /* Alt navigasyon çubuğu için boşluk */
            min-height: calc(100vh - 160px);
        }

        /* Cards */
        .card {
            background: var(--card-background);
            border-radius: 24px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        .card-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 20px;
            letter-spacing: -0.02em;
            /* Mobil için font boyutunu küçült */
            font-size: 20px;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--background-gradient);
            color: white;
            padding: 20px 15px; /* Mobil için padding ayarı */
            border-radius: 20px;
            text-align: center;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            display: block;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 13px;
            opacity: 0.9;
            font-weight: 500;
        }

        /* Input Groups */
        .input-group {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap; /* Mobil için satır atlama */
        }

        .input-group input, .input-group select, 
        .two-column-input input, .two-column-input select {
            flex: 1;
            padding: 16px 20px; /* Mobil için padding ayarı */
            border: 2px solid transparent;
            border-radius: 20px;
            font-size: 15px; /* Mobil için font boyutu */
            font-weight: 500;
            background: linear-gradient(145deg, #f8fafc 0%, #f1f5f9 100%);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: -0.01em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            min-height: 50px; /* Dokunma hedefi için minimum yükseklik */
        }
        /* Inputlar mobil ekranlarda tam genişlikte olsun */
        @media (max-width: 480px) {
            .input-group input, .input-group select,
            .two-column-input input, .two-column-input select {
                width: 100%;
                flex-basis: 100%; /* Flex item olarak tam genişlik */
            }
            .input-group {
                flex-direction: column; /* Input grubunu dikey sırala */
            }
        }


        .two-column-input {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }
        /* İki sütunlu input mobil ekranlarda tek sütuna düşsün */
        @media (max-width: 480px) {
            .two-column-input {
                grid-template-columns: 1fr;
            }
            .two-column-input > div { /* İçindeki div'i de tam genişlik yapın */
                display: flex;
                gap: 12px;
                width: 100%;
            }
             .two-column-input input[type="number"], .two-column-input select {
                width: 100% !important; /* Miktar ve birim inputlarını da genişletin */
                flex: 1; /* Esnekliği koruyun */
            }
        }

        .input-group input:focus, .input-group select:focus,
        .two-column-input input:focus, .two-column-input select:focus {
            outline: none;
            border-color: var(--primary-color);
            background: white;
            box-shadow: 
                0 0 0 4px rgba(99, 102, 241, 0.1),
                0 8px 25px rgba(99, 102, 241, 0.15);
            transform: translateY(-2px);
        }

        .input-group input:hover, .input-group select:hover,
        .two-column-input input:hover, .two-column-input select:hover {
            background: white;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }

        /* Dark Mode için Input */
        [data-theme="dark"] .input-group input, 
        [data-theme="dark"] .input-group select,
        [data-theme="dark"] .two-column-input input,
        [data-theme="dark"] .two-column-input select {
            background: linear-gradient(145deg, #1e293b 0%, #334155 100%);
            color: var(--text-color);
            border-color: transparent;
        }

        [data-theme="dark"] .input-group input:focus,
        [data-theme="dark"] .input-group select:focus,
        [data-theme="dark"] .two-column-input input:focus,
        [data-theme="dark"] .two-column-input select:focus {
            background: #1e293b;
            border-color: var(--primary-color);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 16px 24px; /* Mobil için padding ayarı */
            border-radius: 16px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
            letter-spacing: -0.01em;
            min-height: 52px; /* Dokunma hedefi için minimum yükseklik */
            width: 100%; /* Mobil cihazlarda tam genişlik */
            box-sizing: border-box; /* Padding dahil genişlik */
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #F59E0B 100%);
            color: white;
            border: none;
            padding: 16px 24px; /* Mobil için padding ayarı */
            border-radius: 16px;
            cursor: pointer;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 6px 15px rgba(245, 158, 11, 0.3);
            letter-spacing: -0.01em;
            min-height: 52px; /* Dokunma hedefi için minimum yükseklik */
            box-sizing: border-box;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.4);
        }

        /* Shopping Item - YENİ TASARIM */
        .shopping-item {
            display: flex;
            align-items: center;
            padding: 16px; /* Mobil için padding ayarı */
            background: var(--card-background);
            border-radius: 16px;
            margin-bottom: 12px;
            gap: 12px; /* Daha az gap mobil için */
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .shopping-item:hover {
            border-color: var(--primary-color);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .shopping-item.completed {
            background: #F1F5F9;
            opacity: 0.8;
        }
        [data-theme="dark"] .shopping-item.completed {
            background: #334155; /* Dark mode için completed item rengi */
        }

        .shopping-item.completed .shopping-item-name {
            text-decoration: line-through;
            color: var(--text-light);
        }

        /* Tik Butonu */
        .check-btn {
            width: 38px; /* Dokunma hedefi için boyut büyütüldü */
            height: 38px; /* Dokunma hedefi için boyut büyütüldü */
            border-radius: 50%;
            border: 3px solid var(--border-color);
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 18px; /* İkon boyutu büyütüldü */
            color: transparent;
            flex-shrink: 0; /* İçeriğin sıkışmasını önler */
        }

        .check-btn.completed {
            background: var(--accent-color) !important;
            border-color: var(--accent-color) !important;
            color: white !important;
        }

        .check-btn:hover {
            border-color: var(--accent-color);
            background: rgba(16, 185, 129, 0.1);
        }

        .shopping-item-content {
            flex: 1;
            /* Metinlerin taşmasını engellemek için */
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        /* Uzun metinlerin birden fazla satıra yayılması için */
        .shopping-item-name, .shopping-item-meta {
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .shopping-item-name {
            font-weight: 600;
            color: var(--text-color);
            font-size: 16px;
            margin-bottom: 4px;
        }

        .shopping-item-meta {
            font-size: 12px;
            color: var(--text-light);
        }

        /* Delete Button */
        .delete-btn {
            background: linear-gradient(135deg, var(--danger-color) 0%, var(--danger-dark) 100%) !important;
            color: white !important;
            border: none !important;
            padding: 10px 14px !important;
            border-radius: 12px !important;
            cursor: pointer !important;
            font-size: 16px !important;
            transition: all 0.3s ease !important;
            min-width: 44px !important;
            min-height: 44px !important; /* Dokunma hedefi için minimum yükseklik */
            z-index: 999 !important;
            position: relative !important;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3) !important;
            flex-shrink: 0; /* İçeriğin sıkışmasını önler */
        }

        .delete-btn:hover {
            background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%) !important;
            transform: translateY(-2px) scale(1.05) !important;
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4) !important;
        }

        /* AI Suggestions */
        .ai-suggestions {
            background: var(--card-background);
            border: 1px solid var(--border-color);
            padding: 24px;
            border-radius: 20px;
            border-left: 5px solid var(--primary-color);
            margin-bottom: 24px;
            animation: slideIn 0.5s ease-out;
            box-shadow: var(--shadow);
            color: var(--text-color);
        }

        /* Dark mode için özel AI suggestions stili */
        [data-theme='dark'] .ai-suggestions {
            background: #2D3748;
            border-color: #4A5568;
            color: #E2E8F0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        /* AI suggestions içindeki malzeme öğeleri için ek kontrast */
        .ai-suggestions h3 {
            color: var(--text-color);
            margin-bottom: 16px;
        }

        [data-theme='dark'] .ai-suggestions h3 {
            color: #F7FAFC;
        }

        /* Malzeme listesi öğeleri için stil */
        .ai-suggestions div[style*="display: flex"] {
            color: var(--text-color);
        }

        [data-theme='dark'] .ai-suggestions div[style*="display: flex"] {
            color: #E2E8F0;
        }

        /* Malzeme miktarları için stil */
        .ai-suggestions span[style*="color: var(--text-light)"] {
            color: var(--text-light) !important;
        }

        [data-theme='dark'] .ai-suggestions span[style*="color: var(--text-light)"] {
            color: #A0AEC0 !important;
        }

        /* AI Bot Response */
        .ai-bot-response {
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            margin: 16px 0;
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-color);
            box-shadow: var(--shadow);
            transition: background 0.3s, border-color 0.3s, color 0.3s;
        }

        /* AI Bot Response için özel dark mode iyileştirmesi */
        [data-theme='dark'] .ai-bot-response {
            background: #2D3748;
            border-color: #4A5568;
            color: #E2E8F0;
        }

        /* AI Bot içindeki ürün listesi için ek kontrast */
        .ai-bot-response strong {
            color: var(--primary-color);
            font-weight: 600;
        }

        [data-theme='dark'] .ai-bot-response strong {
            color: #A3BFFA;
        }
        
        /* AI Bot ürün önerileri için liste stili */
        .ai-bot-response ul,
        .ai-bot-response ol {
            margin: 12px 0;
            padding-left: 20px;
        }

        .ai-bot-response li {
            margin: 8px 0;
            color: var(--text-color);
        }

        [data-theme='dark'] .ai-bot-response li {
            color: #CBD5E0;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-15px); }
            to { opacity: 1; transform: translateX(0); }
        }
    
        /* Settings */
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap; /* Küçük ekranlarda sarmalama */
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-weight: 600;
            color: var(--text-color);
            font-size: 16px;
            flex-basis: 100%; /* Küçük ekranlarda etiketin tam genişlik olması */
            margin-bottom: 4px; /* Küçük ekranlarda açıklama ile arasına boşluk */
        }

        .setting-description {
            font-size: 14px;
            color: var(--text-light);
            margin-top: 4px;
            flex-basis: 100%; /* Küçük ekranlarda açıklamanın tam genişlik olması */
        }
        /* Toggle switch için flex düzeni */
        .setting-item > div:first-child {
            flex: 1; /* Etiket ve açıklama için esneklik */
        }
        .setting-item > .toggle-switch {
            margin-left: auto; /* Sağa yaslama */
            flex-shrink: 0; /* Küçülmesini engelle */
        }


        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 56px;
            height: 28px;
            background: #CBD5E1;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 56px; /* Dokunma hedefi için minimum boyut */
            min-height: 28px;
        }

        .toggle-switch.active {
            background: var(--primary-color) !important;
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(28px);
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            background: var(--card-background);
            color: var(--text-color);
            padding: 18px 24px;
            border-radius: 16px;
            z-index: 1001;
            transform: translateX(400px);
            transition: all 0.4s ease;
            box-shadow: var(--shadow-hover);
            border: 1px solid var(--border-color);
            font-weight: 500;
            max-width: 320px;
            word-wrap: break-word; /* Uzun metinlerin sarmalanması için */
            left: 50%; /* Mobil ortalama */
            transform: translateX(-50%) translateY(-100%); /* Başlangıçta yukarıda gizli */
            right: auto; /* Sağdan hizalamayı kaldır */
        }

        .notification.show {
            transform: translateX(-50%) translateY(0); /* Ortadan görünür hale gelmesi */
        }

        /* Category Headers */
        .category-header {
            background: var(--background-gradient);
            color: white;
            padding: 16px 20px; /* Mobil için padding ayarı */
            border-radius: 20px;
            font-weight: 700;
            font-size: 17px; /* Mobil için font boyutu */
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        /* Responsive */
        @media (max-width: 480px) {
            body {
                font-size: 15px; /* Daha küçük mobil cihazlar için temel font boyutu */
            }
            .app-header {
                padding: 20px 16px; /* Header padding mobil için */
            }
            .app-header h1 {
                font-size: 22px;
            }
            .user-info {
                font-size: 13px;
            }
            .main-content {
                padding: 20px 16px; /* Main content padding mobil için */
                padding-bottom: 100px; /* Alt navigasyon için boşluk */
            }
            .card {
                padding: 24px; /* Card padding mobil için */
                border-radius: 20px; /* Card border-radius mobil için */
            }
            .card-title {
                font-size: 18px; /* Card title font size mobil için */
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr); /* 2 sütun */
                gap: 12px;
            }
            .stat-card {
                padding: 18px 10px; /* Stat card padding mobil için */
            }
            .stat-number {
                font-size: 28px; /* Stat number font size mobil için */
            }
            .login-form h1 {
                font-size: 30px; /* Login title font size mobil için */
            }
            .login-form input, .login-form button {
                font-size: 15px; /* Login form input/button font size mobil için */
                padding: 16px 20px;
            }
            .bottom-nav {
                padding: 10px 0;
            }
            .nav-item {
                font-size: 10px;
                padding: 8px 8px;
            }
            .nav-icon {
                font-size: 18px;
            }
            .btn-primary, .btn-secondary {
                padding: 14px 20px;
                font-size: 15px;
            }
        }

        /* YENİ EKLENDİ - Sesli Komut Butonu */
        .voice-btn {
            background: none;
            border: none;
            font-size: 28px;
            color: var(--primary-color);
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            transition: all 0.3s ease;
            height: 64px;
            width: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0; /* Flex konteyner içinde küçülmesini engeller */
        }

        .voice-btn:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        .voice-btn.listening {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 10px 20px rgba(99, 102, 241, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
        }

        /* YENİ EKLENDİ - Akıllı Ürün Önerileri */
        .suggestions-container {
            position: relative;
            width: 100%;
        }

        #product-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            margin-top: 8px;
            z-index: 1000;
            max-height: 180px;
            overflow-y: auto;
            box-shadow: var(--shadow);
        }

        .suggestion-item {
            padding: 14px 20px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s ease;
            font-weight: 500;
            font-size: 15px; /* Öneri metni font boyutu */
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary-color);
        }

        /* Custom Confirmation Modal */
        .confirm-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .confirm-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .confirm-modal-content {
            background: var(--card-background);
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--shadow-hover);
            text-align: center;
            max-width: 320px;
            width: 90%;
            transform: translateY(20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .confirm-modal-overlay.show .confirm-modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .confirm-modal-content h3 {
            font-size: 20px;
            margin-bottom: 15px;
            color: var(--text-color);
        }

        .confirm-modal-content p {
            font-size: 15px;
            color: var(--text-light);
            margin-bottom: 25px;
        }

        .confirm-modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .confirm-modal-buttons button {
            flex: 1;
            padding: 12px 20px;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .confirm-modal-buttons .btn-yes {
            background: linear-gradient(135deg, var(--danger-color) 0%, var(--danger-dark) 100%);
            color: white;
            border: none;
        }

        .confirm-modal-buttons .btn-yes:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .confirm-modal-buttons .btn-no {
            background: var(--border-color);
            color: var(--text-color);
            border: none;
        }

        .confirm-modal-buttons .btn-no:hover {
            background: #CBD5E1;
            transform: translateY(-1px);
        }
        [data-theme="dark"] .confirm-modal-buttons .btn-no {
            background: #4A5568;
            color: #E2E8F0;
        }
        [data-theme="dark"] .confirm-modal-buttons .btn-no:hover {
            background: #606F87;
        }
    </style>
</head>
<body>
    <!-- Notification -->
    <div id="notification" class="notification">
        <div id="notificationText"></div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirmModalOverlay" class="confirm-modal-overlay">
        <div class="confirm-modal-content">
            <h3 id="confirmModalTitle">Emin Misiniz?</h3>
            <p id="confirmModalMessage">Bu işlemi gerçekleştirmek istediğinize emin misiniz?</p>
            <div class="confirm-modal-buttons">
                <button id="confirmBtnNo" class="btn-no">Hayır</button>
                <button id="confirmBtnYes" class="btn-yes">Evet</button>
            </div>
        </div>
    </div>

    <div id="app" class="app-container"></div>

    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(error => console.log('SW registration failed'));
            });
        }

        // Global state
        let appState = {
            user: null,
            currentPage: 'home',
            shoppingList: JSON.parse(localStorage.getItem('akilliMarket_shoppingList') || '[]'),
            newItem: '',
            newQuantity: '1',
            newUnit: 'adet',
            aiQuery: '',
            aiSuggestions: [],
            aiBotResponse: '',
            chefName: localStorage.getItem('akilliMarket_chefName') || 'Aşçı Bey',
            sharedUsers: JSON.parse(localStorage.getItem('akilliMarket_sharedUsers') || '[]'),
            shareCode: localStorage.getItem('akilliMarket_shareCode') || null,
            settings: JSON.parse(localStorage.getItem('akilliMarket_settings') || '{"darkMode":false,"highContrast":false,"largeText":false}'),
            productSuggestions: [],
            aiGeneratedRecipe: null // New state variable for generated recipe
        };

        // AI Aşçı Yemek Veritabanı
        const chefMealDatabase = {
            "mercimek çorbası": {
                ingredients: [
                    { name: 'kırmızı mercimek', quantity: '1 su bardağı' },
                    { name: 'soğan', quantity: '1 adet' },
                    { name: 'havuç', quantity: '1 adet' },
                    { name: 'patates', quantity: '1 adet' },
                    { name: 'tereyağı', quantity: '50g' },
                    { name: 'un', quantity: '1 yemek kaşığı' },
                    { name: 'tuz', quantity: '1 çay kaşığı' }
                ],
                response: "🍲 Besleyici mercimek çorbası! Protein açısından zengin ve sağlıklı bir seçim.",
                instructions: [
                    "Mercimekleri yıkayın ve tencereye alın.",
                    "Soğan, havuç ve patatesi küp küp doğrayıp tencereye ekleyin.",
                    "Üzerini geçecek kadar su ekleyip sebzeler yumuşayana kadar pişirin.",
                    "Ayrı bir tavada tereyağında un kavurun, salça ekleyip kokusu çıkana kadar kavurun.",
                    "Sıcak suyla inceltip çorbaya ekleyin. Tuz ve baharatları ayarlayın.",
                    "Blenderdan geçirip pürüzsüz hale getirin. Servis yapın."
                ]
            },
            "makarna": {
                ingredients: [
                    { name: 'makarna', quantity: '500g' },
                    { name: 'domates sosu', quantity: '1 kutu' },
                    { name: 'parmesan peyniri', quantity: '100g' },
                    { name: 'zeytinyağı', quantity: '3 yemek kaşığı' }
                ],
                response: "🍝 Makarna için gerekli malzemeler hazırlandı! Klasik bir İtalyan lezzeti için bu malzemeler yeterli.",
                instructions: [
                    "Makarnayı bol tuzlu suda paketin üzerindeki tarife göre haşlayın.",
                    "Ayrı bir tavada zeytinyağında domates sosunu ısıtın.",
                    "Haşlanmış makarnayı süzüp sosla karıştırın.",
                    "Servis yaparken üzerine rendelenmiş parmesan peyniri serpin."
                ]
            },
            "omlet": {
                ingredients: [
                    { name: 'yumurta', quantity: '3 adet' },
                    { name: 'süt', quantity: '3 yemek kaşığı' },
                    { name: 'peynir', quantity: '100g' },
                    { name: 'tereyağı', quantity: '1 yemek kaşığı' }
                ],
                response: "🍳 Mükemmel bir omlet için gerekli malzemeler! Protein açısından zengin ve doyurucu bir kahvaltı.",
                instructions: [
                    "Yumurtaları bir kasede süt ile çırpın.",
                    "Tavayı tereyağı ile yağlayıp ısıtın.",
                    "Yumurta karışımını tavaya dökün. Üzerine peynir serpin.",
                    "Kısık ateşte peynir eriyip omlet pişene kadar pişirin. Katlayarak servis edin."
                ]
            },
            "salata": {
                ingredients: [
                    { name: 'marul', quantity: '1 adet' },
                    { name: 'domates', quantity: '2 adet' },
                    { name: 'salatalık', quantity: '1 adet' },
                    { name: 'zeytinyağı', quantity: '3 yemek kaşığı' },
                    { name: 'limon', quantity: '1 adet' }
                ],
                response: "🥗 Taze ve sağlıklı salata malzemeleri! Vitamin açısından zengin bir öğün için ideal.",
                instructions: [
                    "Marul, domates ve salatalığı yıkayıp doğrayın.",
                    "Geniş bir kasede tüm malzemeleri karıştırın.",
                    "Zeytinyağı ve limon suyu ile tatlandırın. İsteğe göre tuz ekleyin."
                ]
            },
            "tavuk çorbası": {
                ingredients: [
                    { name: 'tavuk eti', quantity: '500g' },
                    { name: 'havuç', quantity: '2 adet' },
                    { name: 'soğan', quantity: '1 adet' },
                    { name: 'pirinç', quantity: '1/2 su bardağı' },
                    { name: 'tuz', quantity: '1 çay kaşığı' }
                ],
                response: "🍲 Besleyici tavuk çorbası malzemeleri! Hasta olduğunuzda veya soğuk havalarda ideal.",
                instructions: [
                    "Tavuk etini haşlayın, didin ve suyunu saklayın.",
                    "Havuç ve soğanı doğrayıp tereyağında kavurun.",
                    "Tavuk suyu ve pirinci ekleyip pirinçler yumuşayana kadar pişirin.",
                    "Didilmiş tavuk etini ve tuzu ekleyip bir taşım daha kaynatın. Servis edin."
                ]
            },
            "pizza": {
                ingredients: [
                    { name: 'pizza hamuru', quantity: '2 adet' },
                    { name: 'domates sosu', quantity: '1 kutu' },
                    { name: 'mozzarella peyniri', quantity: '300g' },
                    { name: 'sucuk', quantity: '200g' },
                    { name: 'mantar', quantity: '250g' }
                ],
                response: "🍕 Ev yapımı pizza malzemeleri! Ailenizle birlikte eğlenceli bir yemek deneyimi.",
                instructions: [
                    "Pizza hamurunu açın ve fırın tepsisine yerleştirin.",
                    "Üzerine domates sosu sürün, mozzarella peyniri ve diğer malzemeleri ekleyin.",
                    "Önceden ısıtılmış 200°C fırında peynir eriyip kenarları kızarana kadar pişirin."
                ]
            },
            "tavuklu pilav": {
                ingredients: [
                    { name: 'tavuk eti', quantity: '500g' },
                    { name: 'pirinç', quantity: '2 su bardağı' },
                    { name: 'soğan', quantity: '1 adet' },
                    { name: 'tereyağı', quantity: '50g' },
                    { name: 'tavuk suyu', quantity: '3 su bardağı' },
                    { name: 'tuz', quantity: '1 çay kaşığı' },
                    { name: 'karabiber', quantity: '1 çay kaşığı' }
                ],
                response: "🍚 Geleneksel tavuklu pilav malzemeleri! Türk mutfağının vazgeçilmez lezzeti.",
                instructions: [
                    "Pirinçleri yıkayıp süzün. Tavuk etini haşlayıp didin.",
                    "Soğanı ince ince doğrayıp tereyağında kavurun.",
                    "Pirinçleri ekleyip 2-3 dakika daha kavurun.",
                    "Tavuk suyu ve tuzu ekleyip kısık ateşte pirinçler suyunu çekene kadar pişirin.",
                    "Didilmiş tavuk etini ekleyip karıştırın. Demlenmeye bırakın."
                ]
            },
            "karnıyarık": {
                ingredients: [
                    { name: 'patlıcan', quantity: '6 adet' },
                    { name: 'kıyma', quantity: '500g' },
                    { name: 'soğan', quantity: '2 adet' },
                    { name: 'domates', quantity: '3 adet' },
                    { name: 'biber', quantity: '2 adet' },
                    { name: 'zeytinyağı', quantity: '1/2 su bardağı' },
                    { name: 'maydanoz', quantity: '1 demet' }
                ],
                response: "🍆 Enfes karnıyarık malzemeleri! Türk mutfağının en sevilen yemeklerinden biri.",
                instructions: [
                    "Patlıcanları alacalı soyup kızartın. Ortalarını açıp içlerini oyup tuzlayın.",
                    "Kıymayı soğan, domates, biber ve maydanoz ile kavurun. Baharat ekleyin.",
                    "Patlıcanların içini kıymalı harçla doldurun.",
                    "Fırın tepsisine dizip üzerine domates ve biber dilimleri koyun.",
                    "Biraz su ekleyip 180°C fırında 20-25 dakika pişirin."
                ]
            },
            "menemen": {
                ingredients: [
                    { name: 'yumurta', quantity: '4 adet' },
                    { name: 'domates', quantity: '3 adet' },
                    { name: 'biber', quantity: '2 adet' },
                    { name: 'soğan', quantity: '1 adet' },
                    { name: 'zeytinyağı', quantity: '3 yemek kaşığı' },
                    { name: 'tuz', quantity: '1 çay kaşığı' }
                ],
                response: "🍳 Lezzetli menemen malzemeleri! Türk kahvaltısının vazgeçilmez lezzeti.",
                instructions: [
                    "Soğan ve biberleri ince ince doğrayıp zeytinyağında kavurun.",
                    "Domatesleri rendeleyip veya küp küp doğrayıp tavaya ekleyin. Suyunu çekene kadar pişirin.",
                    "Yumurtaları kırıp karıştırın. Tuz ekleyin.",
                    "Yumurtalar pişince ocaktan alıp sıcak servis yapın."
                ]
            },
            "köfte": {
                ingredients: [
                    { name: 'kıyma', quantity: '500g' },
                    { name: 'soğan', quantity: '1 adet' },
                    { name: 'ekmek içi', quantity: '2 dilim' },
                    { name: 'yumurta', quantity: '1 adet' },
                    { name: 'maydanoz', quantity: '1 demet' },
                    { name: 'tuz', quantity: '1 çay kaşığı' },
                    { name: 'karabiber', quantity: '1 çay kaşığı' }
                ],
                response: "🥩 Ev yapımı köfte malzemeleri! Herkesin sevdiği klasik lezzet.",
                instructions: [
                    "Kıyma, rendelenmiş soğan, ıslatılıp sıkılmış ekmek içi, yumurta, doğranmış maydanoz, tuz ve karabiberi bir kapta yoğurun.",
                    "Harçtan ceviz büyüklüğünde parçalar alıp yuvarlayın veya yassıltın.",
                    "Tavada az yağda veya fırında pişirin. İsteğe göre kızartın veya ızgara yapın."
                ]
            },
            "döner": {
                ingredients: [
                    { name: 'tavuk eti', quantity: '1 kg' },
                    { name: 'lavash', quantity: '6 adet' },
                    { name: 'domates', quantity: '2 adet' },
                    { name: 'salatalık', quantity: '1 adet' },
                    { name: 'soğan', quantity: '1 adet' },
                    { name: 'marul', quantity: '1 adet' },
                    { name: 'sos', quantity: '2 çeşit' }
                ],
                response: "🌯 Ev yapımı döner malzemeleri! Sokak lezzetini evinizde yapın.",
                instructions: [
                    "Tavuk etini ince ince dilimleyin veya jülyen doğrayın.",
                    "Bir tavada etleri yüksek ateşte kızartın.",
                    "Lavash ekmeğini ısıtın. Üzerine etleri yerleştirin.",
                    "Doğranmış domates, salatalık, soğan ve marulu ekleyin.",
                    "İsteğe göre sos ekleyip dürüm yapın."
                ]
            },
            "mantı": {
                ingredients: [
                    { name: 'un', quantity: '500g' },
                    { name: 'yumurta', quantity: '2 adet' },
                    { name: 'kıyma', quantity: '300g' },
                    { name: 'soğan', quantity: '1 adet' },
                    { name: 'yoğurt', quantity: '500g' },
                    { name: 'sarımsak', quantity: '3 diş' },
                    { name: 'tereyağı', quantity: '100g' }
                ],
                response: "🥟 Geleneksel mantı malzemeleri! Türk mutfağının en özel lezzetlerinden.",
                instructions: [
                    "Un, yumurta ve tuz ile sert bir hamur yoğurun. Dinlendirin.",
                    "Kıyma ve rendelenmiş soğan ile iç harcı hazırlayın. Tuz ve karabiber ekleyin.",
                    "Hamuru ince açıp küçük kareler kesin. İç harcı koyup üçgen veya bohça şeklinde kapatın.",
                    "Bol tuzlu suda haşlayın. Yoğurt ve sarımsaklı sos ile servis yapın.",
                    "Üzerine tereyağında kızdırılmış pul biber gezdirin."
                ]
            },
            "ezogelin çorbası": {
                ingredients: [
                    { name: 'kırmızı mercimek', quantity: '1 su bardağı' },
                    { name: 'bulgur', quantity: '1/2 su bardağı' },
                    { name: 'pirinç', quantity: '2 yemek kaşığı' },
                    { name: 'soğan', quantity: '1 adet' },
                    { name: 'salça', quantity: '1 yemek kaşığı' },
                    { name: 'tereyağı', quantity: '50g' },
                    { name: 'nane', quantity: '1 çay kaşığı' },
                    { name: 'tuz', quantity: '1 çay kaşığı' }
                ],
                response: "🥣 Ezogelin çorbası! Geleneksel Türk mutfağının en sevilen çorbalarından.",
                instructions: [
                    "Mercimek, bulgur ve pirinci yıkayın.",
                    "Tencerede tereyağında rendelenmiş soğanı kavurun.",
                    "Salça ekleyip kokusu çıkana kadar kavurun.",
                    "Mercimek, bulgur, pirinç ve su ekleyin. Tuz ve baharatları ayarlayın.",
                    "Sebzeler yumuşayana kadar pişirin. Blendırdan geçirin. Nane ile servis edin."
                ]
            },
            "tarhana çorbası": {
                ingredients: [
                    { name: 'tarhana', quantity: '3 yemek kaşığı' },
                    { name: 'su', quantity: '4 su bardağı' },
                    { name: 'tereyağı', quantity: '50g' },
                    { name: 'tuz', quantity: '1 çay kaşığı' }
                ],
                response: "🍜 Tarhana çorbası! Kış aylarının vazgeçilmez sıcacık lezzeti.",
                instructions: [
                    "Tarhanayı bir kasede soğuk su ile ezin.",
                    "Tencerede tereyağını eritin, nane ve pul biberi kavurun.",
                    "Tarhana karışımını ve suyu ekleyip sürekli karıştırarak kaynatın.",
                    "Kısık ateşte 5-10 dakika daha pişirin. Servis yapın."
                ]
            },
            "domates çorbası": {
                ingredients: [
                    { name: 'domates', quantity: '1 kg' },
                    { name: 'un', quantity: '2 yemek kaşığı' },
                    { name: 'tereyağı', quantity: '50g' },
                    { name: 'süt', quantity: '1 su bardağı' },
                    { name: 'şeker', quantity: '1 çay kaşığı' },
                    { name: 'tuz', quantity: '1 çay kaşığı' }
                ],
                response: "🍅 Domates çorbası! Çocukların en sevdiği hafif ve lezzetli çorba.",
                instructions: [
                    "Domatesleri rendeleyin. Tencerede tereyağını eritin, un ve salçayı kavurun.",
                    "Rendelenmiş domatesi ekleyip karıştırın. Suyu veya sütü azar azar ekleyerek karıştırın.",
                    "Şeker ve tuzu ekleyip kaynamaya bırakın. Blenderdan geçirip pürüzsüz hale getirin."
                ]
            },
            "imam bayıldı": {
                ingredients: [
                    { name: 'patlıcan', quantity: '6 adet' },
                    { name: 'soğan', quantity: '3 adet' },
                    { name: 'sarımsak', quantity: '4 diş' },
                    { name: 'domates', quantity: '2 adet' },
                    { name: 'maydanoz', quantity: '1 demet' },
                    { name: 'zeytinyağı', quantity: '1 su bardağı' }
                ],
                response: "🫒 İmam Bayıldı! Zeytinyağlı sebze yemeklerinin kralı.",
                instructions: [
                    "Patlıcanları alacalı soyup ortadan ikiye kesin ve tuzlu suda bekletin.",
                    "Soğan, sarımsak, domates ve maydanozu ince ince doğrayın.",
                    "Tavada zeytinyağında soğan ve sarımsağı kavurun. Domates ve maydanozu ekleyin.",
                    "Patlıcanları süzüp kurulayın. İçlerini oyup hazırladığınız harcı doldurun.",
                    "Tepsiye dizip üzerine su gezdirin ve 180°C fırında pişirin."
                ]
            },
            "kuru fasulye": {
                ingredients: [
                    { name: 'kuru fasulye', quantity: '500g' },
                    { name: 'et', quantity: '300g' },
                    { name: 'soğan', quantity: '2 adet' },
                    { name: 'domates', quantity: '2 adet' },
                    { name: 'salça', quantity: '2 yemek kaşığı' },
                    { name: 'zeytinyağı', quantity: '3 yemek kaşığı' }
                ],
                response: "🫘 Kuru fasulye! Pilav ile birlikte Türk mutfağının klasiği.",
                instructions: [
                    "Kuru fasulyeleri bir gece önceden ıslatın ve ertesi gün haşlayın.",
                    "Tencerede zeytinyağında etleri kavurun. Soğanı ekleyip pembeleşene kadar kavurun.",
                    "Salça ve domatesi ekleyip karıştırın.",
                    "Haşlanmış fasulyeyi ekleyin, üzerini geçecek kadar sıcak su ekleyin. Tuz ve baharatları ayarlayın.",
                    "Kısık ateşte fasulyeler yumuşayana kadar pişirin."
                ]
            },
            "pilav": {
                ingredients: [
                    { name: 'pirinç', quantity: '2 su bardağı' },
                    { name: 'tereyağı', quantity: '50g' },
                    { name: 'su', quantity: '3 su bardağı' },
                    { name: 'tuz', quantity: '1 çay kaşığı' }
                ],
                response: "🍚 Pilav! Türk mutfağının vazgeçilmez yan yemeği.",
                instructions: [
                    "Pirinçleri yıkayıp ılık tuzlu suda 20 dakika bekletin, sonra süzün.",
                    "Tencerede tereyağını eritin, pirinçleri ekleyip 5 dakika kavurun.",
                    "Kaynar suyu ve tuzu ekleyip karıştırın. Kısık ateşte suyunu çekene kadar pişirin.",
                    "Ocaktan alıp 10 dakika dinlendirin. Demlendikten sonra karıştırıp servis edin."
                ]
            },
            "bulgur pilavı": {
                ingredients: [
                    { name: 'bulgur', quantity: '2 su bardağı' },
                    { name: 'soğan', quantity: '1 adet' },
                    { name: 'tereyağı', quantity: '50g' },
                    { name: 'su', quantity: '3 su bardağı' },
                    { name: 'tuz', quantity: '1 çay kaşığı' }
                ],
                response: "🌾 Bulgur pilavı! Sağlıklı ve doyurucu bir alternatif.",
                instructions: [
                    "Soğanı ince doğrayın. Tereyağında pembeleşene kadar kavurun.",
                    "Bulguru ekleyip 2-3 dakika daha kavurun.",
                    "Suyu ve tuzu ekleyip kısık ateşte bulgur suyunu çekene kadar pişirin.",
                    "Demlenmeye bırakın, ardından servis edin."
                ]
            },
            "kısır": {
                ingredients: [
                    { name: 'ince bulgur', quantity: '2 su bardağı' },
                    { name: 'domates', quantity: '3 adet' },
                    { name: 'salatalık', quantity: '2 adet' },
                    { name: 'maydanoz', quantity: '1 demet' },
                    { name: 'nane', quantity: '1/2 demet' },
                    { name: 'limon', quantity: '2 adet' },
                    { name: 'zeytinyağı', quantity: '4 yemek kaşığı' }
                ],
                response: "🥗 Kısır! Hafif ve ferahlatıcı Türk salatası.",
                instructions: [
                    "İnce bulguru bir kaba alın, üzerini geçmeyecek kadar sıcak su ekleyip şişmeye bırakın.",
                    "Domates, salatalık, maydanoz ve naneyi ince ince doğrayın.",
                    "Şişen bulgura doğranmış malzemeleri, limon suyunu, zeytinyağını, salçayı ve baharatları ekleyip iyice karıştırın."
                ]
            },
            "çoban salata": {
                ingredients: [
                    { name: 'domates', quantity: '4 adet' },
                    { name: 'salatalık', quantity: '2 adet' },
                    { name: 'soğan', quantity: '1 adet' },
                    { name: 'biber', quantity: '2 adet' },
                    { name: 'maydanoz', quantity: '1 demet' },
                    { name: 'limon', quantity: '1 adet' },
                    { name: 'zeytinyağı', quantity: '3 yemek kaşığı' }
                ],
                response: "🥗 Çoban salata! Taze ve vitamin dolu klasik salata.",
                instructions: [
                    "Tüm sebzeleri küçük küpler halinde doğrayın.",
                    "Doğradığınız tüm malzemeleri geniş bir kasede birleştirin.",
                    "Üzerine taze sıkılmış limon suyu, zeytinyağı ve tuz gezdirin. İyice karıştırıp servis edin."
                ]
            },
            "mücver": {
                ingredients: [
                    { name: 'kabak', quantity: '3 adet' },
                    { name: 'yumurta', quantity: '2 adet' },
                    { name: 'un', quantity: '3 yemek kaşığı' },
                    { name: 'dereotu', quantity: '1 demet' },
                    { name: 'soğan', quantity: '1 adet' },
                    { name: 'tuz', quantity: '1 çay kaşığı' }
                ],
                response: "🥬 Kabak mücveri! Sebze sevmeyenlerin bile bayılacağı lezzet.",
                instructions: [
                    "Kabakları rendeleyip suyunu sıkın. Soğanı ve dereotunu ince doğrayın.",
                    "Bir kapta rendelenmiş kabak, soğan, dereotu, yumurta, un ve tuzu karıştırın.",
                    "Tavada az yağda veya fırında mücverleri kızarana kadar pişirin."
                ]
            }, 
            "lahmacun": {
                ingredients: [
                    { name: 'un', quantity: '500g' },
                    { name: 'kıyma', quantity: '300g' },
                    { name: 'soğan', quantity: '2 adet' },
                    { name: 'domates', quantity: '2 adet' },
                    { name: 'biber', quantity: '1 adet' },
                    { name: 'maydanoz', quantity: '1 demet' },
                    { name: 'baharat karışımı', quantity: '1 çay kaşığı' }
                ],
                response: "🫓 Lahmacun! Türk pizzası olarak bilinen enfes lezzet.",
                instructions: [
                    "Hamur için un, su, tuz ve maya ile yumuşak bir hamur yoğurun. Dinlendirin.",
                    "İç harç için kıyma, rendelenmiş soğan, domates, biber, maydanoz ve baharatları karıştırın.",
                    "Hamurdan bezeler yapıp ince açın. Üzerine harcı yayın.",
                    "Önceden ısıtılmış fırında veya sacda kızarana kadar pişirin."
                ]
            },
            "börek": {
                ingredients: [
                    { name: 'yufka', quantity: '10 adet' },
                    { name: 'peynir', quantity: '400g' },
                    { name: 'yumurta', quantity: '3 adet' },
                    { name: 'süt', quantity: '2 su bardağı' },
                    { name: 'zeytinyağı', quantity: '1/2 su bardağı' }
                ],
                response: "🥧 Su böreği! Türk mutfağının en sevilen hamur işi.",
                instructions: [
                    "Bir sos tenceresinde süt, zeytinyağı ve yumurtaları çırpın. ",
                    "Yufkaların arasına bu karışımı sürerek kat kat dizin. Peynirli harcı arasına serin.",
                    "Önceden ısıtılmış fırında üzeri kızarana kadar pişirin."
                ]
            },
            "gözleme": {
                ingredients: [
                    { name: 'un', quantity: '3 su bardağı' },
                    { name: 'su', quantity: '1 su bardağı' },
                    { name: 'tuz', quantity: '1 çay kaşığı' },
                    { name: 'peynir', quantity: '200g' },
                    { name: 'ıspanak', quantity: '500g' },
                    { name: 'tereyağı', quantity: '100g' }
                ],
                response: "🫓 Gözleme! Köy kahvaltılarının vazgeçilmez lezzeti.",
                instructions: [
                    "Hamur için un, su ve tuzu yoğurun. Dinlendirin.",
                    "İç harç için peyniri ezin, ıspanağı doğrayıp karıştırın.",
                    "Hamurdan bezeler açıp iç harcı yerleştirin ve katlayın.",
                    "Sacda veya tavada tereyağı ile arkalı önlü kızarana kadar pişirin."
                ]
            },
            "tavuk şiş": {
                ingredients: [
                    { name: 'tavuk', quantity: '1 kg' },
                    { name: 'soğan', quantity: '2 adet' },
                    { name: 'biber', quantity: '3 adet' },
                    { name: 'zeytinyağı', quantity: '3 yemek kaşığı' },
                    { name: 'baharat karışımı', quantity: '1 çay kaşığı' }
                ],
                response: "🍗 Tavuk şiş! Mangalın en sağlıklı seçeneği.",
                instructions: [
                    "Tavuk etini küp küp doğrayın. Soğan ve biberi de doğrayın.",
                    "Tavuk etlerini zeytinyağı ve baharatlarla marine edin.",
                    "Şişlere tavuk ve sebzeleri sırayla dizin.",
                    "Mangalda veya ızgarada tavuklar kızarana kadar pişirin."
                ]
            },
            "ızgara balık": {
                ingredients: [
                    { name: 'balık', quantity: '1 kg' },
                    { name: 'limon', quantity: '2 adet' },
                    { name: 'zeytinyağı', quantity: '3 yemek kaşığı' },
                    { name: 'tuz', quantity: '1 çay kaşığı' },
                    { name: 'karabiber', quantity: '1 çay kaşığı' }
                ],
                response: "🐟 Izgara balık! Omega-3 açısından zengin sağlıklı seçim.",
                instructions: [
                    "Balığı temizleyip yıkayın ve kağıt havlu ile kurulayın.",
                    "Zeytinyağı, limon suyu, tuz ve karabiber ile marine edin.",
                    "Izgarada veya tavada balıkları her iki tarafı da kızarana kadar pişirin.",
                    "Yanında yeşil salata ile servis yapın."
                ]
            }
        };

        const emojiMap = {
            'domates': '🍅', 'salatalık': '🥒', 'elma': '🍎', 'muz': '🍌', 'patates': '🥔',
            'soğan': '🧅', 'marul': '🥬', 'limon': '🍋', 'havuç': '🥕', 'biber': '🌶️',
            'patlıcan': '�', 'kabak': '🥒', 'tavuk': '🍗', 'dana eti': '🥩', 'balık': '🐟',
            'süt': '🥛', 'yoğurt': '🥛', 'peynir': '🧀', 'yumurta': '🥚', 'ekmek': '🍞',
            'pirinç': '🍚', 'makarna': '🍝', 'un': '🌾', 'şeker': '🍯', 'tuz': '🧂',
            'zeytinyağı': '🌿', 'zeytin': '🍇', 'su': '💧', 'deterjan': '🧴', 'sabun': '🧼',
            'bal': '🍯', 'badem': '🥜', 'ceviz': '🥜', 'fındık': '🥜', 'çikolata': '🍫',
            'çay': '☕', 'kahve': '☕', 'çilek': '🍓', 'kiraz': '🍒', 'üzüm': '🍇'
        };

        // Akıllı Ürün Öneri Veritabanı
        const productDatabase = [
            '🥑 Avokado', '🍎 Amasya Elması', '🌰 Antep Fıstığı', '🥛 Ayran', '🌻 Ay Çekirdeği', 
            '🌾 Arpa', '🌶️ Acı Biber', '🍯 Akasya Balı', '🧅 Arpacık Soğanı', '🥬 Arugula', 
            '🌾 Amarant', '🥜 Antep Fıstığı Ezmesi',
            '🥜 Badem', '🍯 Bal', '🐟 Balık', '🌾 Barbunya', '🌶️ Biber', '🥦 Brokoli', 
            '🌾 Bulgur', '🍪 Bisküvi', '🧀 Beyaz Peynir', '🥖 Baget', '🍇 Böğürtlen', 
            '🥩 Bonfile', '🍺 Bira', '🥬 Brüksel Lahanası', '🌶️ Biber Salçası', '🧈 Butter', 
            '🥨 Bagel', '🍌 Banana Chips', '🥩 Beefsteak', '🧀 Brie Peyniri', '🥖 Brioche', '🌾 Buğday',
            '🥜 Ceviz', '🥨 Cips', '🍒 Cherry', '🧀 Cheddar', '🧀 Camembert', '🌶️ Chili', 
            '🍫 Cocoa', '☕ Cappuccino', '🥒 Cornichon', '🥥 Coconut',
            '🍒 Çilek', '🍫 Çikolata', '☕ Çay', '🍓 Çilek Reçeli', '🍫 Çikolatalı Bisküvi', 
            '🌿 Çemen', '🧀 Çökelek', '🌲 Çam Fıstığı', '🌾 Çavdar', '🍲 Çorba', '🍓 Çilek Marmelatı',
            '🥩 Dana Eti', '🌿 Dereotu', '🧴 Deterjan', '🪥 Diş Macunu', '🍩 Donut', '🍅 Domates', 
            '🍦 Dondurma', '🍅 Domates Salçası', '🌿 Defne Yaprağı', '🍇 Dut', '🥩 Döner', 
            '🍞 Dilim Ekmek', '🧀 Dil Peyniri', '🥛 Demirhindi',
            '🍞 Ekmek', '🍎 Elma', '🥬 Enginar', '🍑 Erik', '🥚 Yumurta', '🧀 Ezine Peyniri',
            '🍎 Elma Suyu', '🍎 Elma Sirkesi', '🌿 Estragon', '🥬 Ebegümeci', '🍇 Ekşi Üzüm',
            '🍞 Esmer Ekmek', '🧀 Emmental', '☕ Espresso', '🍝 Erişte',
            '🥜 Fındık', '🥜 Fıstık', '🌾 Fasulye', '🐟 Fener Balığı', '🍇 Fig',
            '🥜 Fındık Ezmesi', '🌾 Fasulye Pilaki', '🍞 Focaccia', '🧀 Feta', '🍓 Frambuaz',
            '🥛 Frappuccino', '🍟 French Fries', '🥖 French Bread',
            '🥨 Galeta', '🍊 Greyfurt', '🧀 Gouda', '🥛 Greek Yogurt', '🌹 Gül Yaprağı', 
            '🍯 Gül Balı', '🥒 Gurme Turşu', '🥤 Gazoz', '🥣 Granola', '🧀 Gruyere', 
            '🍇 Grape Juice', '🫚 Ginger',
            '🥕 Havuç', '🦃 Hindi', '🌰 Hurma', '🥒 Hıyar', '🌭 Hardal', '🥛 Hazelnut Milk', 
            '🍯 Heather Honey', '🧀 Halloumi', '🌺 Hibiscus', '🥕 Havuç Suyu', '🦃 Hindi Göğsü', 
            '🌰 Hurma Ezmesi', '☕ Hot Chocolate',
            '🥬 Ispanak', '🍇 İncir', '🧊 Iced Tea', '🍦 Ice Cream', '🌿 Italian Herbs',
            '🧀 İzmir Tulum', '🍇 İncir Reçeli', '🥛 İrmik', '🌿 İtalyan Baharatı', '🍞 İtalyan Ekmeği',
            '🧊 Jel', '🍇 Jelly', '🧃 Juice', '🌶️ Jalapeno', '🍯 Jam',
            '☕ Kahve', '🥒 Kabak', '🧀 Kaşar', '🥜 Kaju', '🍉 Karpuz', '🍒 Kiraz', '🥩 Kıyma', 
            '🥥 Hindistan Cevizi', '🧀 Krem Peynir', '🍪 Kurabiye', '🥜 Kuruyemiş', '🌶️ Kimyon',
            '🥬 Kıvırcık', '🍋 Kireç', '🧀 Kaşkaval', '🐑 Kuzu Eti', '🍒 Kiraz Reçeli', 
            '🥛 Kefir', '🌾 Kinoa', '🥒 Kornişon', '🍪 Kraker', '🧀 Krem Şanti', 
            '🍫 Kakao', '🌿 Kekik', '🌿 Kapari',
            '🍋 Limon', '🧀 Lor Peyniri', '🥬 Lahana', '🍋 Limon Suyu', '🧀 Labne',
            '☕ Latte', '🥬 Leek', '🍋 Lime', '🧀 Limburger', '🍯 Lavanta Balı',
            '🍝 Makarna', '🍈 Kavun', '🥛 Süt', '🍄 Mantar', '🥭 Mango', '🌿 Maydanoz', 
            '🌽 Mısır', '🧀 Mozzarella', '🍌 Muz', '🥛 Milkshake', '🍯 Manuka Balı', 
            '🥜 Macadamia', '🍈 Melon', '🧀 Mascarpone', '🍵 Matcha', '🌿 Mint', 
            '🍖 Meatball', '🍝 Macaroni', '☕ Mocha', '🧀 Muenster', '🍄 Morel Mantarı', '🥭 Mango Suyu',

            '🌾 Nohut', '🌿 Nane', '🍇 Nar', '🍫 Nutella', '🥜 Nut Mix', '🍇 Nar Ekşisi', 
            '🌿 Nane Yaprağı', '🧀 Neufchatel', '🍫 Nesquik',
            '🍹Oralet', '🍪Oreo', '🐟Orkinos', '🔥Ocak Çakmağı', '💅 Oje',
            '🦆 Ördek', '🧀Örgü Peyniri', '👩‍🍳Önlük', '🌶️ Öğütülmüş Karabiber', '🥛 Özel Süt',
            '🥔 Patates', '🧀 Peynir', '🍑 Şeftali', '🥞 Pankek', '🍕 Pizza', '🍊 Portakal', 
            '🍿 Patlamış Mısır', '🧀 Parmesan', '🌿 Parsley', '🥤 Protein Shake', '🍑 Peach', 
            '🥜 Peanut', '🍐 Pear', '🌶️ Paprika', '🍕 Pepperoni', '🥞 Pancake Mix', 
            '🧀 Provolone', '🍇 Plum', '🍮 Pudding',
            '🍓 Reçel', '🍚 Pirinç', '🥬 Roka', '🍇 Raisin', '🧀 Ricotta', '🌿 Rosemary', 
            '🥛 Rice Milk', '🍓 Raspberry', '🍞 Rye Bread',
            '🧂 Tuz', '🥛 Süt', '🌭 Sosis', '🥩 Salam', '🧄 Sarımsak', '🥒 Salatalık', 
            '🌻 Susam', '🥩 Sucuk', '💧 Su', '🍓 Strawberry', '🧀 Swiss Cheese', '🥛 Soy Milk', 
            '🌿 Sage', '🍯 Sunflower Honey', '🥜 Sunflower Seeds', '🥛 Smoothie', '🧀 Stilton', 
            '🌶️ Sriracha', '🥤 Soda', '🍝 Spaghetti',
            '🍑 Şeftali', '🍯 Şeker', '🍯 Şeker Pancarı', '🥛 Şekersiz Süt', '🌿 Şerbetçiotu',
            '🧀 Şavak Peyniri', '🍇 Şıra', '🥤 Şalgam',
            '🍗 Tavuk', '🧈 Tereyağı', '🧻 Tuvalet Kağıdı', '🥜 Tahin', '🍅 Domates', '🧂 Tuz', 
            '🌿 Thyme', '🧀 Tilsit', '🍵 Tea', '🍅 Tomato Sauce', '🦃 Turkey', '🥜 Tahini', 
            '🌿 Turmeric', '🧀 Tulum Peyniri', '🥤 Tonic Water',
            '🌾 Un', '🍇 Üzüm', '🥛 UHT Milk', '🌿 Umami Sauce', '🍇 Üzüm Suyu',
            '🍒 Vişne', '🧀 Velveeta', '🌿 Vanilla Extract', '🍒 Vişne Suyu', '🥛 Vitamin Water',
            '🍉 Watermelon', '🥛 Whey Protein', '🌾 Wheat', '🧀 White Cheese',
            '🥚 Yumurta', '🥛 Yoğurt', '🌾 Yulaf', '🧈 Yağ', '🍇 Yaban Mersini', '🥛 Yakult', 
            '🧀 Yak Peyniri', '🍵 Yeşil Çay', '🥜 Yer Fıstığı', '🥛 Yogurt Drink', '🌾 Yeast', '🍠 Yam',
            '🍇 Zeytin', '🌿 Zeytinyağı', '🫚 Zencefil', '🧀 Zürih Peyniri', '🥤 Zero Calorie Drink', 
            '🌶️ Zatar', '🍋 Zest'
        ].filter((item, index, self) => {
            const cleanItem = item.replace(/^[^\w\s]+\s*/, '').toLowerCase();
            return index === self.findIndex(t => t.replace(/^[^\w\s]+\s*/, '').toLowerCase() === cleanItem);
        }).sort((a, b) => {
            const cleanA = a.replace(/^[^\w\s]+\s*/, '').toLowerCase();
            const cleanB = b.replace(/^[^\w\s]+\s*/, '').toLowerCase();
            return cleanA.localeCompare(cleanB, 'tr');
        });

        // Emoji Haritalama Fonksiyonu
        function getItemEmoji(item) {
            const itemLower = item.toLowerCase().trim();
            
            if (emojiMap[itemLower]) {
                return emojiMap[itemLower];
            }
            
            if (itemLower === 'bal') return '🍯';
            if (itemLower === 'balık') return '🐟';
            if (itemLower === 'badem') return '🥜';
            if (itemLower === 'barbunya') return '🌾';
            
            if (itemLower.includes('balık')) return '🐟';
            if (itemLower.includes('bal') && !itemLower.includes('balık')) return '🍯';
            
            if (itemLower.includes('domates')) return '🍅';
            if (itemLower.includes('elma')) return '🍎';
            if (itemLower.includes('muz')) return '🍌';
            if (itemLower.includes('portakal')) return '🍊';
            if (itemLower.includes('limon')) return '🍋';
            if (itemLower.includes('üzüm')) return '🍇';
            if (itemLower.includes('çilek')) return '🍓';
            if (itemLower.includes('kiraz')) return '🍒';
            if (itemLower.includes('şeftali') || itemLower.includes('erik')) return '🍑';
            if (itemLower.includes('avokado')) return '🥑';
            if (itemLower.includes('karpuz')) return '🍉';
            if (itemLower.includes('kavun')) return '🍈';
            if (itemLower.includes('ananas')) return '🍍';
            if (itemLower.includes('kivi')) return '🥝';
            if (itemLower.includes('mango')) return '🥭';
            if (itemLower.includes('salatalık') || itemLower.includes('hıyar')) return '🥒';
            if (itemLower.includes('havuç')) return '🥕';
            if (itemLower.includes('patates')) return '🥔';
            if (itemLower.includes('soğan')) return '🧅';
            if (itemLower.includes('sarımsak')) return '🧄';
            if (itemLower.includes('biber')) return '🌶️';
            if (itemLower.includes('patlıcan')) return '🍆';
            if (itemLower.includes('brokoli')) return '🥦';
            if (itemLower.includes('lahana') || itemLower.includes('ispanak') || itemLower.includes('marul')) return '🥬';
            if (itemLower.includes('mantar')) return '🍄';
            if (itemLower.includes('mısır')) return '🌽';
            
            if (itemLower.includes('tavuk')) return '🍗';
            if (itemLower.includes('et') || itemLower.includes('dana') || itemLower.includes('kuzu')) return '🥩';
            if (itemLower.includes('kıyma')) return '🥩';
            if (itemLower.includes('sucuk') || itemLower.includes('sosis') || itemLower.includes('salam')) return '🌭';
            if (itemLower.includes('süt')) return '🥛';
            if (itemLower.includes('yoğurt') || itemLower.includes('ayran')) return '🥛';
            if (itemLower.includes('peynir')) return '🧀';
            if (itemLower.includes('yumurta')) return '🥚';
            if (itemLower.includes('tereyağı') || itemLower.includes('margarin')) return '🧈';
            
            if (itemLower.includes('ekmek')) return '🍞';
            if (itemLower.includes('pirinç')) return '🍚';
            if (itemLower.includes('makarna')) return '🍝';
            if (itemLower.includes('bulgur') || itemLower.includes('mercimek') || itemLower.includes('nohut')) return '🌾';
            if (itemLower.includes('fasulye') || itemLower.includes('barbunya')) return '🌾';
            if (itemLower.includes('un')) return '🌾';
            
            if (itemLower.includes('fındık') || itemLower.includes('ceviz') || itemLower.includes('badem')) return '🥜';
            if (itemLower.includes('fıstık')) return '🥜';
            
            if (itemLower.includes('su')) return '💧';
            if (itemLower.includes('çay')) return '☕';
            if (itemLower.includes('kahve')) return '☕';
            if (itemLower.includes('kola') || itemLower.includes('gazoz')) return '🥤';
            if (itemLower.includes('meyve suyu') || itemLower.includes('suyu')) return '🧃';
            
            if (itemLower.includes('çikolata')) return '🍫';
            if (itemLower.includes('şeker')) return '🍯';
            if (itemLower.includes('bisküvi') || itemLower.includes('kurabiye')) return '🍪';
            if (itemLower.includes('cips')) return '🥨';
            
            if (itemLower.includes('deterjan') || itemLower.includes('sabun')) return '🧴';
            if (itemLower.includes('şampuan')) return '🧴';
            if (itemLower.includes('diş macunu')) return '🪥';
            if (itemLower.includes('tuvalet kağıdı') || itemLower.includes('kağıt havlu')) return '🧻';
            
            if (itemLower.includes('tuz')) return '🧂';
            if (itemLower.includes('karabiber') || itemLower.includes('baharat')) return '🌶️';
            if (itemLower.includes('nane') || itemLower.includes('maydanoz') || itemLower.includes('dereotu')) return '🌿';
            
            if (itemLower.includes('zeytinyağı') || itemLower.includes('yağ')) return '🌿';
            if (itemLower.includes('zeytin')) return '🍇';
            
            return '🛒';
        }

        // Save to localStorage
        function saveToStorage() {
            localStorage.setItem('akilliMarket_shoppingList', JSON.stringify(appState.shoppingList));
            localStorage.setItem('akilliMarket_settings', JSON.stringify(appState.settings));
            localStorage.setItem('akilliMarket_chefName', appState.chefName);
            localStorage.setItem('akilliMarket_sharedUsers', JSON.stringify(appState.sharedUsers));
            localStorage.setItem('akilliMarket_shareCode', appState.shareCode);
        }

        // Notification System
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            
            // Remove previous type classes
            notification.classList.remove('notification-success', 'notification-error', 'notification-info');
            notification.classList.add(`notification-${type}`);

            // Apply styles based on type (CSS variables are now used more directly)
            if (type === 'success') {
                notification.style.background = 'var(--card-background)';
                notification.style.color = 'var(--text-color)';
            } else if (type === 'error') {
                notification.style.background = '#FEE2E2'; // Light red for error background
                notification.style.color = '#DC2626';     // Dark red for error text
            } else { // info
                notification.style.background = 'var(--card-background)';
                notification.style.color = 'var(--primary-color)';
            }

            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // Update state and re-render
        function updateState(newState) {
            appState = { ...appState, ...newState };
            saveToStorage();
            render();
        }

        // Event handlers
        function handleLogin(username) {
            updateState({
                user: { 
                    name: username, 
                    id: Date.now(),
                    trustScore: 85
                }
            });
            showNotification(`Hoş geldin ${username}! 🎉`);
        }

        // Kategorileme fonksiyonu
        function categorizeItem(itemName) {
            const name = itemName.toLowerCase().trim();
            const categories = {
                'Meyve & Sebze': ['elma', 'armut', 'muz', 'portakal', 'limon', 'mandalina', 'üzüm', 'çilek', 'kiraz', 'şeftali', 'domates', 'salatalık', 'soğan', 'sarımsak', 'patates', 'havuç', 'kabak', 'patlıcan', 'biber', 'marul', 'roka', 'maydanoz', 'dereotu', 'nane', 'fesleğen', 'avokado', 'ananas', 'kivi', 'lahana', 'karnabahar', 'brokoli', 'ispanak', 'semizotu', 'bamya', 'fasulye', 'bezelye'],
                'Et & Tavuk': ['et', 'dana', 'kuzu', 'koyun', 'tavuk', 'hindi', 'balık', 'ton', 'somon', 'levrek', 'köfte', 'sucuk', 'salam', 'jambon', 'pastırma', 'karides', 'midye', 'ahtapot'],
                'Süt Ürünleri': ['süt', 'yoğurt', 'peynir', 'kaşar', 'beyaz peynir', 'tulum', 'lor', 'krema', 'tereyağı', 'margarin', 'ayran', 'kefir', 'labne', 'ricotta', 'mozzarella', 'kaşkaval'],
                'Unlu Mamuller': ['ekmek', 'somun', 'francala', 'pide', 'simit', 'poğaça', 'börek', 'makarna', 'spagetti', 'erişte', 'bulgur', 'pirinç', 'un', 'maya', 'galeta', 'bisküvi', 'kraker'],
                'İçecek': ['su', 'çay', 'kahve', 'kola', 'fanta', 'sprite', 'meyve suyu', 'şarap', 'bira', 'gazoz', 'soda', 'ayran', 'smoothie', 'enerji içeceği', 'limonata'],
                'Temizlik': ['deterjan', 'sabun', 'şampuan', 'diş macunu', 'temizlik', 'çamaşır', 'bulaşık', 'kağıt havlu', 'tuvalet kağıdı', 'mendil', 'çöp poşeti', 'sünger'],
                'Bakliyat': ['nohut', 'mercimek', 'fasulye', 'barbunya', 'börülce', 'bezelye', 'bakla', 'soya'],
                'Baharat': ['tuz', 'karabiber', 'kırmızı biber', 'kimyon', 'nane', 'kekik', 'defne', 'tarçın', 'karanfil', 'baharat', 'curry', 'zerdeçal', 'sumak'],
                'Atıştırmalık': ['cips', 'çikolata', 'gofret', 'kek', 'kurabiye', 'kraker', 'çerez', 'fındık', 'fıstık', 'badem', 'ceviz', 'dondurma', 'şeker', 'lokum']
            };
            
            for (const [category, keywords] of Object.entries(categories)) {
                for (const keyword of keywords) {
                    if (name.includes(keyword)) {
                        return category;
                    }
                }
            }
            return 'Diğer';
        }

        // Ürün ekleme fonksiyonu
        function addItem(name, quantity, unit) {
            if (!name || !name.trim()) {
                showNotification('❌ Lütfen ürün adı girin!', 'error');
                return;
            }
            
            if (!quantity || quantity <= 0) {
                showNotification('❌ Lütfen geçerli bir miktar girin!', 'error');
                return;
            }
            
            const emoji = getItemEmoji(name);
            const displayQuantity = `${quantity} ${unit}`;
            
            const newShoppingItem = {
                id: Date.now() + Math.random(),
                name: name.trim(),
                quantity: displayQuantity,
                displayName: `${name.trim()} (${displayQuantity})`,
                emoji: emoji,
                completed: false,
                completedBy: null,
                addedBy: appState.user?.name || 'Anonim',
                category: categorizeItem(name),
                addedAt: new Date().toLocaleString('tr-TR')
            };
            
            try {
                updateState({
                    shoppingList: [...appState.shoppingList, newShoppingItem],
                    newItem: '',
                    newQuantity: '1',
                    newUnit: 'adet'
                });
                
                appState.productSuggestions = [];
                const suggestionsEl = document.getElementById('product-suggestions');
                if (suggestionsEl) {
                    suggestionsEl.innerHTML = '';
                }
                
                const nameInput = document.getElementById('newItemInput'); // ID düzeltildi
                const quantityInput = document.getElementById('newQuantityInput'); // ID düzeltildi
                const unitSelect = document.getElementById('newUnitSelect'); // ID düzeltildi
                
                if (nameInput) nameInput.value = '';
                if (quantityInput) quantityInput.value = '1';
                if (unitSelect) unitSelect.value = 'adet';
                
                showNotification(`${emoji} ${name.trim()} (${displayQuantity}) listeye eklendi! ✅`, 'success');
                
            } catch (error) {
                console.error('Ürün eklenirken hata:', error);
                showNotification('❌ Ürün eklenirken bir hata oluştu!', 'error');
            }
        }

        // Form submit handler
        function handleAddItemSubmit(event) {
            event.preventDefault();
            
            const nameInput = document.getElementById('newItemInput'); // ID düzeltildi
            const quantityInput = document.getElementById('newQuantityInput'); // ID düzeltildi
            const unitSelect = document.getElementById('newUnitSelect'); // ID düzeltildi
            
            if (!nameInput || !quantityInput || !unitSelect) {
                console.error('Form elementleri bulunamadı');
                showNotification('❌ Form elementleri bulunamadı!', 'error');
                return;
            }
            
            const name = nameInput.value.trim();
            const quantity = parseFloat(quantityInput.value);
            const unit = unitSelect.value;
            
            addItem(name, quantity, unit);
        }

        // Buton click handler
        function handleAddButtonClick() {
            const nameInput = document.getElementById('newItemInput'); // ID düzeltildi
            const quantityInput = document.getElementById('newQuantityInput'); // ID düzeltildi
            const unitSelect = document.getElementById('newUnitSelect'); // ID düzeltildi
            
            if (!nameInput || !quantityInput || !unitSelect) {
                console.error('Form elementleri bulunamadı');
                showNotification('❌ Form elementleri bulunamadı!', 'error');
                return;
            }
            
            const name = nameInput.value.trim();
            const quantity = parseFloat(quantityInput.value);
            const unit = unitSelect.value;
            
            addItem(name, quantity, unit);
        }

        // Event listener'ları bağlama (DOMContentLoaded içinde olmalı)
        document.addEventListener('DOMContentLoaded', function() {
            // addItem fonksiyonu artık render içinde çağrılmıyor, addNewItem fonksiyonu çağırıyor.
            // Bu nedenle, add-item-form ve add-item-btn artık doğrudan DOM'da bulunmayabilir.
            // Sadece eğer bu ID'lere sahip elementler varsa dinleyici eklenmeli.

            // Home render edildikten sonra elementler DOM'a ekleniyor
            // Bu event listener'lar render fonksiyonu içinde veya render sonrası çağrılan bir fonksiyonda kurulmalı.
            // Şimdilik burayı yoruma alıyorum, render sonrası fonksiyonlara taşınacak.
        });


        function toggleItemComplete(id) {
            const updatedList = appState.shoppingList.map(item => {
                if (String(item.id) === String(id)) {
                    const newCompleted = !item.completed;
                    return { 
                        ...item, 
                        completed: newCompleted,
                        completedBy: newCompleted ? appState.user.name : null,
                        completedAt: newCompleted ? new Date().toLocaleString('tr-TR') : null
                    };
                }
                return item;
            });
            
            updateState({ shoppingList: updatedList });
            
            const item = updatedList.find(item => String(item.id) === String(id));
            if (item) {
                if (item.completed) {
                    showNotification(`${item.emoji} ${item.name} ${item.completedBy} tarafından alındı! ✅`);
                } else {
                    showNotification(`${item.emoji} ${item.name} tekrar listeye eklendi! 🔄`);
                }
            }
        }

        function deleteItemFromList(id) {
            const item = appState.shoppingList.find(item => String(item.id) === String(id));
            if (!item) {
                showNotification('Ürün bulunamadı!', 'error');
                return;
            }
            
            const updatedList = appState.shoppingList.filter(item => String(item.id) !== String(id));
            updateState({ shoppingList: updatedList });
            showNotification(`${item.emoji} ${item.name} listeden silindi! 🗑️`);
        }

        // Levenshtein Distance for "Did you mean?" functionality
        function levenshteinDistance(a, b) {
            if (a.length === 0) return b.length;
            if (b.length === 0) return a.length;
            
            const matrix = [];
            for (let i = 0; i <= b.length; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= a.length; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    const cost = (a[j - 1] === b[i - 1]) ? 0 : 1;
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j] + 1,      // deletion
                        matrix[i][j - 1] + 1,      // insertion
                        matrix[i - 1][j - 1] + cost // substitution
                    );
                }
            }
            return matrix[b.length][a.length];
        }

        function handleAiQuery() {
            const query = appState.aiQuery.toLowerCase().trim();
            
            if (!query) {
                showNotification('Lütfen bir yemek adı yazın!', 'error');
                return;
            }

            let found = false;
            let matchedMeal = null;
            let closestMatch = null;
            let minDistance = Infinity;

            for (const [mealName, mealData] of Object.entries(chefMealDatabase)) {
                // Exact match or includes
                if (query === mealName || mealName.includes(query)) {
                    matchedMeal = mealData;
                    found = true;
                    break;
                }
                
                // Calculate Levenshtein distance for "Did you mean?"
                const distance = levenshteinDistance(query, mealName);
                if (distance < minDistance) {
                    minDistance = distance;
                    closestMatch = mealName;
                }
            }

            if (found && matchedMeal) {
                updateState({
                    aiSuggestions: matchedMeal.ingredients,
                    aiBotResponse: `${matchedMeal.response}\n\n**Yapılışı:**\n${matchedMeal.instructions.map((inst, index) => `${index + 1}. ${inst}`).join('\n')}`
                });
            } else {
                let responseText = `Hmm, "${query}" mi? 🤔 ${appState.chefName} şu anda bu tarifi araştırıyor!`;
                
                // Suggest if a close match is found (threshold for similarity, e.g., distance < 3 for short words)
                if (closestMatch && minDistance <= Math.max(query.length, closestMatch.length) * 0.4) { // Dynamic threshold
                    responseText += `\n\nBunu mu demek istediniz: <strong>${closestMatch.charAt(0).toUpperCase() + closestMatch.slice(1)}</strong>?`;
                }

                const availableMeals = Object.keys(chefMealDatabase).slice(0, 8).join(', ');
                
                updateState({
                    aiSuggestions: [],
                    aiBotResponse: `${responseText}\n\n👨‍🍳 ${appState.chefName}'in bildiği tariflerden bazıları: ${availableMeals}...`
                });
            }
        }

        function addAiSuggestionsToList() {
            if (!appState.aiSuggestions || appState.aiSuggestions.length === 0) {
                showNotification('Eklenecek malzeme bulunamadı!', 'error');
                return;
            }
            
            const newItems = [];
            
            appState.aiSuggestions.forEach(item => {
                const emoji = getItemEmoji(item.name);
                const newItem = {
                    id: Date.now() + Math.random(),
                    name: item.name,
                    quantity: item.quantity || '1 adet',
                    displayName: `${item.name} (${item.quantity || '1 adet'})`,
                    emoji: emoji,
                    completed: false,
                    completedBy: null,
                    addedBy: appState.user?.name,
                    category: categorizeItem(item.name),
                    addedAt: new Date().toLocaleString('tr-TR')
                };
                newItems.push(newItem);
            });
            
            const updatedShoppingList = [...appState.shoppingList, ...newItems];
            
            updateState({
                shoppingList: updatedShoppingList,
                aiSuggestions: [],
                aiBotResponse: '',
                aiQuery: '',
                currentPage: 'home'
            });
            
            showNotification(`${newItems.length} malzeme anasayfaya eklendi! ✅`, 'success');
        }

        function toggleDarkModeFunction() {
            const newDarkMode = !appState.settings.darkMode;
            const newSettings = { ...appState.settings, darkMode: newDarkMode };
            updateState({ settings: newSettings });
            
            if (newDarkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
            
            showNotification(newDarkMode ? 'Gece modu açıldı 🌙' : 'Gündüz modu açıldı ☀️');
        }

        function toggleSetting(settingName) {
            const newSettings = { 
                ...appState.settings, 
                [settingName]: !appState.settings[settingName] 
            };
            
            updateState({ settings: newSettings });
            
            if (settingName === 'highContrast') {
                if (newSettings.highContrast) {
                    document.body.classList.add('high-contrast');
                    showNotification('Yüksek kontrast açıldı 🔆');
                } else {
                    document.body.classList.remove('high-contrast');
                    showNotification('Yüksek kontrast kapatıldı');
                }
            }
            
            if (settingName === 'largeText') {
                if (newSettings.largeText) {
                    document.body.classList.add('large-text');
                    showNotification('Büyük yazı açıldı 📝');
                } else {
                    document.body.classList.remove('large-text');
                    showNotification('Normal yazı boyutu');
                }
            }
        }

        // Sesli Komut Fonksiyonları
        function startVoiceRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                showNotification('Sesli komut tarayıcınızda desteklenmiyor.', 'error');
                return;
            }

            const recognition = new SpeechRecognition();
            recognition.lang = 'tr-TR';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            const voiceBtn = document.getElementById('voiceBtn');
            if (voiceBtn) voiceBtn.classList.add('listening');

            recognition.start();

            recognition.onresult = function(event) {
                const speechResult = event.results[0][0].transcript.toLowerCase();
                handleVoiceCommand(speechResult);
            };

            recognition.onspeechend = function() {
                recognition.stop();
                if (voiceBtn) voiceBtn.classList.remove('listening');
            };

            recognition.onerror = function(event) {
                showNotification('Ses tanımada hata oluştu: ' + event.error, 'error');
                if (voiceBtn) voiceBtn.classList.remove('listening');
            };
        }

        function handleVoiceCommand(command) {
            const parts = command.split(' ');
            let itemName = '';
            let quantity = '1';
            let unit = 'adet';
            const itemParts = parts.filter(part => part !== 'ekle' && part !== 'al');

            const quantityIndex = itemParts.findIndex(part => !isNaN(parseFloat(part)));
            if(quantityIndex > -1) {
                quantity = itemParts[quantityIndex];
                const unitWord = itemParts[quantityIndex + 1];
                if (['kilo', 'kg', 'gram', 'gr', 'litre', 'lt', 'paket', 'adet', 'şişe'].includes(unitWord)) {
                    unit = unitWord;
                    itemName = itemParts.filter((p, i) => i !== quantityIndex && i !== quantityIndex + 1).join(' ');
                } else {
                     itemName = itemParts.filter((p, i) => i !== quantityIndex).join(' ');
                }
            } else {
                itemName = itemParts.join(' ');
            }
            
            if (itemName.trim()) {
                addItem(itemName.trim(), quantity, unit);
                showNotification(`🎙️ Sesli komutla eklendi: ${itemName.trim()}`, 'success');
            } else {
                showNotification('Anlaşılamadı, lütfen "2 kilo elma ekle" gibi tekrar deneyin.', 'error');
            }
        }

        // Akıllı Ürün Öneri Fonksiyonları
        function showSuggestions() {
            const inputElement = document.getElementById('newItemInput');
            const suggestionsContainer = document.getElementById('product-suggestions');

            if (!inputElement || !suggestionsContainer) return;

            const value = inputElement.value.toLowerCase();
            appState.newItem = inputElement.value; // appState'i güncel tut

            if (!value) {
                appState.productSuggestions = [];
                suggestionsContainer.innerHTML = '';
                return;
            }

            const suggestions = productDatabase.filter(item => {
                const cleanItem = item.replace(/^[^\w\s]+\s*/, '').toLowerCase();
                return cleanItem.startsWith(value);
            }).slice(0, 8);

            appState.productSuggestions = suggestions;

            suggestionsContainer.innerHTML = suggestions.map(item => `
                <div class="suggestion-item" onclick="selectSuggestion('${item.replace(/'/g, '\\\'')}')">${item}</div>
            `).join('');
        }

        function selectSuggestion(itemName) {
            const nameInput = document.getElementById('newItemInput');
            const suggestionsContainer = document.getElementById('product-suggestions');
            
            if (nameInput) {
                const cleanItemName = itemName.replace(/^[^\w\s]+\s*/, '');
                nameInput.value = cleanItemName;
                nameInput.focus();
            }
            
            appState.newItem = itemName.replace(/^[^\w\s]+\s*/, '');
            appState.productSuggestions = [];
            
            if (suggestionsContainer) {
                suggestionsContainer.innerHTML = '';
            }
            
            updateState({ 
                newItem: itemName.replace(/^[^\w\s]+\s*/, ''),
                productSuggestions: [] 
            });
        }

        // Render functions
        function renderLogin() {
            return `
                <div class="login-container">
                    <div class="login-form">
                        <div class="login-logo-container">
                            <span class="login-logo">🛍️</span>
                            <h1>AkıllıMarket</h1>
                        </div>
                        <p>Akıllı alışveriş asistanınız</p>
                        <input type="text" id="loginInput" placeholder="Kullanıcı adınızı girin">
                        <button onclick="handleLoginClick()">Başlayalım</button>
                    </div>
                </div>
            `;
        }

        function renderHome() {
            const totalItems = appState.shoppingList.length;
            const completedItems = appState.shoppingList.filter(item => item.completed).length;
            const groupedItems = appState.shoppingList.reduce((groups, item) => {
                const category = item.category;
                if (!groups[category]) {
                    groups[category] = [];
                }
                groups[category].push(item);
                return groups;
            }, {});
            const categories = Object.keys(groupedItems).length;

            return `
                <header class="app-header">
                    <h1>
                        <span class="header-logo">🛍️</span>
                        AkıllıMarket
                    </h1>
                    <div class="user-info">
                        ${appState.user.name}
                        <button onclick="logout()">Çıkış</button>
                    </div>
                </header>

                <div class="main-content">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <span class="stat-number">${totalItems}</span>
                            <span class="stat-label">Ürün</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number">${completedItems}</span>
                            <span class="stat-label">Alındı</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number">${categories}</span>
                            <span class="stat-label">Kategori</span>
                        </div>
                    </div>

                    ${!appState.shareCode ? `
                        <div class="card">
                            <h2 class="card-title">👥 Aile Listesi</h2>
                            <p style="margin-bottom: 16px; color: var(--text-light);">
                                Aileniz, eşiniz veya ev arkadaşınızla aynı alışveriş listesini paylaşın!
                            </p>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                <button class="btn-primary" onclick="createSharedList()" style="flex: 1; min-width: 140px;">
                                    📱 Liste Oluştur
                                </button>
                                <button class="btn-secondary" onclick="joinSharedListPrompt()" style="flex: 1; min-width: 140px;">
                                    🔗 Listeye Katıl
                                </button>
                            </div>
                        </div>
                    ` : `
                        <div class="card">
                            <h2 class="card-title">👥 Aile Listesi</h2>
                            <p style="margin-bottom: 12px;">
                                <strong>Paylaşım Kodu:</strong> <span style="background: var(--primary-color); color: white; padding: 4px 8px; border-radius: 8px; font-weight: bold;">${appState.shareCode}</span>
                            </p>
                            <p style="margin-bottom: 16px; color: var(--text-light);">
                                <strong>Katılımcılar:</strong> ${appState.sharedUsers.map(user => user.name + (user.isOwner ? ' (Sahibi)' : '')).join(', ')}
                            </p>
                            <button class="btn-secondary" onclick="generateQRCode()" style="background: linear-gradient(135deg, var(--accent-color) 0%, #059669 100%); margin-bottom: 12px;">
                                📱 Paylaş
                            </button>
                            <button class="btn-secondary" onclick="leaveSharedListConfirm()" style="background: linear-gradient(135deg, var(--danger-color) 0%, var(--danger-dark) 100%);">
                                👋 Listeden Ayrıl
                            </button>
                        </div>
                    `}

                    <div class="card">
                        <h2 class="card-title">✨ Ürün Ekle</h2>
                        <div style="display: flex; align-items: flex-start; gap: 10px; flex-wrap: wrap;">
                            <div class="suggestions-container" style="flex-grow: 1; flex-basis: calc(100% - 74px);">
                                <div class="two-column-input" style="margin-bottom: 0;">
                                    <input 
                                        type="text" 
                                        id="newItemInput" 
                                        placeholder="Ürün adı yazın veya mikrofona basın" 
                                        value="${appState.newItem}"
                                        oninput="showSuggestions()"
                                        autocomplete="off">
                                    <div style="display: flex; gap: 12px;">
                                        <input type="number" id="newQuantityInput" placeholder="Miktar" value="${appState.newQuantity}" style="width: 80px;">
                                        <select id="newUnitSelect" style="width: 100px;">
                                            <option value="adet" ${appState.newUnit === 'adet' ? 'selected' : ''}>Adet</option>
                                            <option value="kg" ${appState.newUnit === 'kg' ? 'selected' : ''}>Kg</option>
                                            <option value="g" ${appState.newUnit === 'g' ? 'selected' : ''}>Gram</option>
                                            <option value="l" ${appState.newUnit === 'l' ? 'selected' : ''}>Litre</option>
                                            <option value="ml" ${appState.newUnit === 'ml' ? 'selected' : ''}>ML</option>
                                            <option value="paket" ${appState.newUnit === 'paket' ? 'selected' : ''}>Paket</option>
                                            <option value="şişe" ${appState.newUnit === 'şişe' ? 'selected' : ''}>Şişe</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="product-suggestions">
                                    ${appState.productSuggestions.map(item => `
                                        <div class="suggestion-item" onclick="selectSuggestion('${item.replace(/'/g, '\\\'')}')">${item}</div>
                                    `).join('')}
                                </div>
                            </div>
                            <button id="voiceBtn" class="voice-btn" onclick="startVoiceRecognition()">🎤</button>
                        </div>
                        <button class="btn-primary" style="width: 100%; margin-top: 24px;" onclick="addNewItem()">🛒 Ürün Ekle</button>
                    </div>

                    ${Object.keys(groupedItems).length > 0 ? Object.keys(groupedItems).map(category => `
                        <div class="category-header">
                            ${category}
                            <span>${groupedItems[category].length}</span>
                        </div>
                        ${groupedItems[category].map(item => `
                            <div class="shopping-item ${item.completed ? 'completed' : ''}">
                                <button class="check-btn ${item.completed ? 'completed' : ''}" onclick="toggleItemComplete('${item.id}')">
                                    ${item.completed ? '✓' : ''}
                                </button>
                                <span style="font-size: 24px; flex-shrink: 0;">${item.emoji}</span>
                                <div class="shopping-item-content">
                                    <div class="shopping-item-name">${item.name}</div>
                                    <div class="shopping-item-meta">
                                        ${item.quantity} • ${item.addedBy} ekledi
                                        ${item.completed ? ` • ${item.completedBy} aldı` : ''}
                                    </div>
                                </div>
                                <button class="delete-btn" onclick="deleteItemFromList('${item.id}')">🗑️</button>
                            </div>
                        `).join('')}
                    `).join('') : '<div class="card"><p style="text-align: center; color: var(--text-light);">Henüz ürün eklenmemiş 🛒</p></div>'}
                </div>

                <nav class="bottom-nav">
                    <div class="nav-item ${appState.currentPage === 'home' ? 'active' : ''}" onclick="changePage('home')">
                        <div class="nav-icon">🏠</div>
                        <span>Ana Sayfa</span>
                    </div>
                    <div class="nav-item ${appState.currentPage === 'chef' ? 'active' : ''}" onclick="changePage('chef')">
                        <div class="nav-icon">👨‍🍳</div>
                        <span>Aşçı</span>
                    </div>
                    <div class="nav-item ${appState.currentPage === 'settings' ? 'active' : ''}" onclick="changePage('settings')">
                        <div class="nav-icon">⚙️</div>
                        <span>Ayarlar</span>
                    </div>
                </nav>
            `;
        }

        function renderChef() {
            return `
                <header class="app-header">
                    <h1>
                        <span class="header-logo">🛍️</span>
                        ${appState.chefName}
                    </h1>
                    <div class="user-info">
                        ${appState.user.name}
                        <button onclick="logout()">Çıkış</button>
                    </div>
                </header>

                <div class="main-content">
                    <div class="card">
                        <h2 class="card-title">👨‍🍳 Aşçı Ayarları</h2>
                        <div class="input-group">
                            <input type="text" id="chefNameInput" placeholder="Aşçınızın adını girin" value="${appState.chefName}">
                            <button class="btn-primary" onclick="updateChefName()">Güncelle</button>
                        </div>
                        <p style="font-size: 13px; color: var(--text-light); margin-top: 8px;">
                            💡 Aşçınıza istediğiniz ismi verebilirsiniz!
                        </p>
                    </div>

                    <div class="card">
                        <h2 class="card-title">👨‍🍳 Yemek Ara</h2>
                        <div class="input-group">
                            <input type="text" id="aiQueryInput" placeholder="Hangi yemek yapmak istiyorsun?" value="${appState.aiQuery}">
                            <button class="btn-primary" onclick="handleAiQueryClick()">Ara</button>
                        </div>
                        <p style="font-size: 13px; color: var(--text-light); margin-top: 8px;">
                            💡 Örnek: "makarna", "omlet", "pizza"
                        </p>
                    </div>

                    ${appState.aiBotResponse ? `
                        <div class="ai-bot-response">
                            <h3 style="margin-bottom: 12px;">🤖 ${appState.chefName} Diyor:</h3>
                            <p style="white-space: pre-line;">${appState.aiBotResponse}</p>
                        </div>
                    ` : ''}

                    ${appState.aiSuggestions.length > 0 ? `
                        <div class="ai-suggestions">
                            <h3 style="margin-bottom: 16px;">🛒 Gerekli Malzemeler:</h3>
                            ${appState.aiSuggestions.map(item => `
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                    <span style="font-size: 20px; flex-shrink: 0;">${getItemEmoji(item.name)}</span>
                                    <span style="font-weight: 500;">${item.name}</span>
                                    <span style="color: var(--text-light); flex-shrink: 0;">(${item.quantity})</span>
                                </div>
                            `).join('')}
                            <button class="btn-secondary" onclick="addAiSuggestionsToList()" style="margin-top: 16px;">
                                Tümünü Listeye Ekle
                            </button>
                        </div>
                    ` : ''}

                    <!-- New section for AI Recipe Generation -->
                    <div class="card">
                        <h2 class="card-title">✨ ${appState.chefName} Tarif Oluştur</h2>
                        <div class="input-group">
                            <textarea id="recipeIngredientsInput" placeholder="Sahip olduğunuz malzemeleri virgülle ayırarak yazın (örn: tavuk, pirinç, havuç)" rows="3" style="width: 100%; padding: 16px; border-radius: 16px; border: 1px solid var(--border-color); resize: vertical; background: var(--background-color); color: var(--text-color);"></textarea>
                        </div>
                        <button class="btn-primary" onclick="generateRecipeWithAI()">✨ Tarif Oluştur</button>
                        <div id="loadingIndicator" style="display: none; text-align: center; margin-top: 15px; color: var(--primary-color);">Yükleniyor...</div>
                        <div id="aiGeneratedRecipe" style="margin-top: 20px;">
                            <!-- AI tarafından oluşturulan tarif burada gösterilecek -->
                            ${appState.aiGeneratedRecipe ? `
                                <div class="card" style="margin-top: 20px;">
                                    <h3 class="card-title">${appState.aiGeneratedRecipe.recipeName}</h3>
                                    <h4 style="font-size: 18px; margin-bottom: 10px; color: var(--primary-color);">Malzemeler:</h4>
                                    <ul style="list-style: disc; margin-left: 20px; margin-bottom: 20px;">
                                        ${appState.aiGeneratedRecipe.ingredients.map(ing => `
                                            <li>${getItemEmoji(ing.item)} ${ing.item}: <strong>${ing.quantity}</strong></li>
                                        `).join('')}
                                    </ul>
                                    <h4 style="font-size: 18px; margin-bottom: 10px; color: var(--primary-color);">Talimatlar:</h4>
                                    <ol style="list-style: decimal; margin-left: 20px;">
                                        ${appState.aiGeneratedRecipe.instructions.map(inst => `
                                            <li>${inst}</li>
                                        `).join('')}
                                    </ol>
                                    <button class="btn-primary" onclick="addRecipeIngredientsToList()">Tarif Malzemelerini Listeye Ekle</button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>

                <nav class="bottom-nav">
                    <div class="nav-item ${appState.currentPage === 'home' ? 'active' : ''}" onclick="changePage('home')">
                        <div class="nav-icon">🏠</div>
                        <span>Ana Sayfa</span>
                    </div>
                    <div class="nav-item ${appState.currentPage === 'chef' ? 'active' : ''}" onclick="changePage('chef')">
                        <div class="nav-icon">👨‍🍳</div>
                        <span>Aşçı</span>
                    </div>
                    <div class="nav-item ${appState.currentPage === 'settings' ? 'active' : ''}" onclick="changePage('settings')">
                        <div class="nav-icon">⚙️</div>
                        <span>Ayarlar</span>
                    </div>
                </nav>
            `;
        }

        function renderSettings() {
            return `
                <header class="app-header">
                    <h1>
                        <span class="header-logo">🛍️</span>
                        Ayarlar
                    </h1>
                    <div class="user-info">
                        ${appState.user.name}
                        <button onclick="logout()">Çıkış</button>
                    </div>
                </header>

                <div class="main-content">
                    <div class="card">
                        <h2 class="card-title">🎨 Görünüm</h2>
                        
                        <div class="setting-item">
                            <div>
                                <div class="setting-label">Gece Modu</div>
                                <div class="setting-description">Koyu tema kullan</div>
                            </div>
                            <div class="toggle-switch ${appState.settings.darkMode ? 'active' : ''}" onclick="toggleDarkModeFunction()">
                                <div class="toggle-slider"></div>
                            </div>
                        </div>

                        <div class="setting-item">
                            <div>
                                <div class="setting-label">Yüksek Kontrast</div>
                                <div class="setting-description">Daha net görünüm</div>
                            </div>
                            <div class="toggle-switch ${appState.settings.highContrast ? 'active' : ''}" onclick="toggleSetting('highContrast')">
                                <div class="toggle-slider"></div>
                            </div>
                        </div>

                        <div class="setting-item">
                            <div>
                                <div class="setting-label">Büyük Yazı</div>
                                <div class="setting-description">Yazıları büyüt</div>
                            </div>
                            <div class="toggle-switch ${appState.settings.largeText ? 'active' : ''}" onclick="toggleSetting('largeText')">
                                <div class="toggle-slider"></div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h2 class="card-title">📢 Sosyal Paylaşım</h2>
                        <p style="margin-bottom: 16px; color: var(--text-light);">
                            Başarılarınızı veya listelerinizi arkadaşlarınızla paylaşın!
                        </p>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <button class="btn-primary" onclick="shareShoppingList()">
                                📝 Alışveriş Listemi Paylaş
                            </button>
                            <button class="btn-secondary" onclick="shareAchievement()">
                                🏆 Başarımı Paylaş
                            </button>
                            <button class="btn-secondary" onclick="shareFavoriteProduct()">
                                ❤️ Favori Ürünümü Paylaş
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <h2 class="card-title">🤝 Sosyal Etkileşim</h2>
                        <p style="margin-bottom: 16px; color: var(--text-light);">
                            Arkadaşlarınızı davet edin veya yarışmalara katılın!
                        </p>
                        <div class="input-group">
                            <input type="text" id="friendInviteInput" placeholder="Arkadaşınızın adını girin">
                            <button class="btn-primary" onclick="inviteFriend()">Davet Et</button>
                        </div>
                        <button class="btn-secondary" onclick="showCompetitionsInfo()">
                            🏅 Yarışmalar (Yakında)
                        </button>
                    </div>

                    <div class="card">
                        <h2 class="card-title">📊 İstatistikler</h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: center;">
                            <div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--primary-color);">${appState.shoppingList.length}</div>
                                <div style="font-size: 14px; color: var(--text-light);">Toplam Ürün</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--accent-color);">${appState.shoppingList.filter(item => item.completed).length}</div>
                                <div style="font-size: 14px; color: var(--text-light);">Alınan Ürün</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h2 class="card-title">🗑️ Veri Yönetimi</h2>
                        <button class="btn-secondary" onclick="clearAllDataConfirm()" style="background: linear-gradient(135deg, var(--danger-color) 0%, var(--danger-dark) 100%);">
                            Tüm Verileri Temizle
                        </button>
                        <p style="font-size: 12px; color: var(--text-light); margin-top: 8px;">
                            ⚠️ Bu işlem geri alınamaz
                        </p>
                    </div>
                </div>

                <nav class="bottom-nav">
                    <div class="nav-item ${appState.currentPage === 'home' ? 'active' : ''}" onclick="changePage('home')">
                        <div class="nav-icon">🏠</div>
                        <span>Ana Sayfa</span>
                    </div>
                    <div class="nav-item ${appState.currentPage === 'chef' ? 'active' : ''}" onclick="changePage('chef')">
                        <div class="nav-icon">👨‍🍳</div>
                        <span>Aşçı</span>
                    </div>
                    <div class="nav-item ${appState.currentPage === 'settings' ? 'active' : ''}" onclick="changePage('settings')">
                        <div class="nav-icon">⚙️</div>
                        <span>Ayarlar</span>
                    </div>
                </nav>
            `;
        }

        // Global functions
        function generateShareCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function createSharedList() {
            const shareCode = generateShareCode();
            updateState({ 
                shareCode: shareCode,
                sharedUsers: [{ name: appState.user.name, id: appState.user.id, isOwner: true }]
            });
            showNotification(`Paylaşım kodu: ${shareCode} - Bu kodu ailenizle paylaşın! 📱`);
        }

        function joinSharedList(code) {
            if (!code || code.length !== 6) {
                showNotification('Geçersiz paylaşım kodu!', 'error');
                return;
            }
            
            // Check if user is already in the shared list
            const isUserAlreadyInList = appState.sharedUsers.some(user => user.id === appState.user.id);
            if (!isUserAlreadyInList) {
                const newSharedUsers = [...appState.sharedUsers, { 
                    name: appState.user.name, 
                    id: appState.user.id, 
                    isOwner: false 
                }];
                updateState({ 
                    shareCode: code,
                    sharedUsers: newSharedUsers
                });
                showNotification(`${code} kodlu listeye katıldınız! 🎉`);
            } else {
                showNotification('Zaten bu listeye katılmışsınız.', 'info');
            }
        }

        function leaveSharedList() {
            updateState({ 
                shareCode: null,
                sharedUsers: []
            });
            showNotification('Paylaşımlı listeden ayrıldınız! 👋');
        }

        // Custom Confirmation Modal Logic
        let confirmCallback = null; // Store the callback function

        function showConfirmModal(title, message, onConfirm) {
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalMessage').textContent = message;
            document.getElementById('confirmModalOverlay').classList.add('show');
            confirmCallback = onConfirm; // Set the callback
        }

        function hideConfirmModal() {
            document.getElementById('confirmModalOverlay').classList.remove('show');
            confirmCallback = null; // Clear the callback
        }

        // Event listeners for the custom confirmation modal buttons
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('confirmBtnYes').addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback();
                }
                hideConfirmModal();
            });

            document.getElementById('confirmBtnNo').addEventListener('click', () => {
                hideConfirmModal();
            });

            // Close modal if clicking outside (optional, but good UX)
            document.getElementById('confirmModalOverlay').addEventListener('click', (e) => {
                if (e.target.id === 'confirmModalOverlay') {
                    hideConfirmModal();
                }
            });
        });

        // Updated confirmAction to use the custom modal
        function confirmAction(message, callback) {
            showConfirmModal('Emin Misiniz?', message, callback);
        }

        window.createSharedList = createSharedList;
        window.joinSharedListPrompt = function() {
            // Kullanıcıdan kodu almak için daha iyi bir UI kullanılmalı
            const code = prompt('Paylaşım kodunu girin:');
            if (code) joinSharedList(code.toUpperCase());
        };
        window.leaveSharedListConfirm = function() {
            confirmAction('Paylaşımlı listeden ayrılmak istediğinizden emin misiniz?', leaveSharedList);
        };

        // Tab Senkronizasyonu
        function syncWithOtherTabs() {
            window.addEventListener('storage', (e) => {
                if (e.key === 'akilliMarket_shoppingList') {
                    const newList = JSON.parse(e.newValue || '[]');
                    // Sadece farklıysa güncelle
                    if (JSON.stringify(appState.shoppingList) !== JSON.stringify(newList)) {
                        appState.shoppingList = newList;
                        render(); // Force re-render without saving again
                        showNotification('Liste başka sekmeden güncellendi! 🔄');
                    }
                }
                if (e.key === 'akilliMarket_shareCode') {
                    const newShareCode = e.newValue;
                    if (appState.shareCode !== newShareCode) {
                        appState.shareCode = newShareCode;
                        render();
                    }
                }
                if (e.key === 'akilliMarket_sharedUsers') {
                    const newSharedUsers = JSON.parse(e.newValue || '[]');
                     if (JSON.stringify(appState.sharedUsers) !== JSON.stringify(newSharedUsers)) {
                        appState.sharedUsers = newSharedUsers;
                        render();
                    }
                }
                if (e.key === 'akilliMarket_settings') {
                    const newSettings = JSON.parse(e.newValue || '{}');
                    if (JSON.stringify(appState.settings) !== JSON.stringify(newSettings)) {
                        appState.settings = newSettings;
                        document.documentElement.setAttribute('data-theme', newSettings.darkMode ? 'dark' : '');
                        document.body.classList.toggle('high-contrast', newSettings.highContrast);
                        document.body.classList.toggle('large-text', newSettings.largeText);
                        render();
                    }
                }
            });
        }

        // QR Kod Paylaşımı (Basit bir kopyalama işlevi, QR kod görseli üretmez)
        function generateQRCode() {
            const url = `${window.location.origin}${window.location.pathname}?shareCode=${appState.shareCode}`;
            const qrText = `AkıllıMarket Listesi\nKod: ${appState.shareCode}\nLink: ${url}`;
            
            // Clipboard API'si modern tarayıcılarda tercih edilir
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(qrText).then(() => {
                    showNotification('Liste bilgileri panoya kopyalandı! 📋');
                }).catch(err => {
                    console.error('Panoya kopyalama başarısız oldu (Clipboard API):', err);
                    // Fallback için execCommand kullan
                    copyTextToClipboardFallback(qrText);
                });
            } else {
                // Eski tarayıcılar için fallback
                copyTextToClipboardFallback(qrText);
            }
        }

        // Clipboard API desteği olmayan tarayıcılar için fallback
        function copyTextToClipboardFallback(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed'; // Ekran dışına taşı
            textArea.style.left = '-9999px';
            textArea.style.top = '-9999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showNotification('Liste bilgileri panoya kopyalandı! 📋');
            } catch (err) {
                console.error('Panoya kopyalama başarısız oldu (execCommand):', err);
                showNotification('Panoya kopyalanamadı, lütfen manuel kopyalayın.', 'error');
            } finally {
                document.body.removeChild(textArea);
            }
        }

        // --- Sosyal Paylaşım Fonksiyonları ---
        async function shareContent(title, text) {
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: title,
                        text: text,
                    });
                    showNotification('İçerik başarıyla paylaşıldı! 🚀');
                } catch (error) {
                    if (error.name === 'AbortError') {
                        showNotification('Paylaşma iptal edildi.', 'info');
                    } else {
                        console.error('İçerik paylaşılırken hata:', error);
                        showNotification('İçerik paylaşılamadı.', 'error');
                    }
                }
            } else {
                // Fallback: Copy to clipboard
                copyTextToClipboardFallback(`${title}\n${text}`);
                showNotification('Paylaşım özelliği desteklenmiyor. İçerik panoya kopyalandı! 📋');
            }
        }

        window.shareShoppingList = function() {
            const listItems = appState.shoppingList.map(item => `${getItemEmoji(item.name)} ${item.name} (${item.quantity})`).join('\n');
            const message = `AkıllıMarket alışveriş listem:\n${listItems}\n\n#AkıllıMarket #AlışverişListesi`;
            shareContent('AkıllıMarket Alışveriş Listem', message);
        };

        window.shareAchievement = function() {
            const completedCount = appState.shoppingList.filter(item => item.completed).length;
            const totalCount = appState.shoppingList.length;
            const message = `Bugün AkıllıMarket ile ${totalCount} üründen ${completedCount} tanesini aldım! 🚀 Harika bir alışveriş günü! #AkıllıMarket #Başarı`;
            shareContent('AkıllıMarket Başarım', message);
        };

        window.shareFavoriteProduct = function() {
            let favoriteProduct = 'Favori bir ürünüm yok.';
            if (appState.shoppingList.length > 0) {
                // For simplicity, let's pick a random item or the most recent one
                const randomIndex = Math.floor(Math.random() * appState.shoppingList.length);
                const item = appState.shoppingList[randomIndex];
                favoriteProduct = `En sevdiğim ürün: ${getItemEmoji(item.name)} ${item.name} (${item.quantity})! Sizinki ne?`;
            } else {
                favoriteProduct = "Henüz alışveriş listemde bir ürün yok, ama çok yakında harika ürünler ekleyeceğim!";
            }
            const message = `${favoriteProduct}\n\n#AkıllıMarket #FavoriÜrün`;
            shareContent('AkıllıMarket Favori Ürünüm', message);
        };

        // --- Sosyal Etkileşim Fonksiyonları (Simüle Edilmiş) ---
        window.inviteFriend = function() {
            const friendNameInput = document.getElementById('friendInviteInput');
            const friendName = friendNameInput ? friendNameInput.value.trim() : '';

            if (friendName) {
                showNotification(`${friendName} adlı arkadaşına davet gönderildi! 🎉 (Simülasyon)`, 'success');
                if (friendNameInput) friendNameInput.value = ''; // Clear input
            } else {
                showNotification('Lütfen davet etmek istediğiniz arkadaşınızın adını girin.', 'info');
            }
        };

        window.showCompetitionsInfo = function() {
            showNotification('Yarışma ve özel etkinlik özelliklerimiz çok yakında aktif olacak! Bizi takipte kalın. 🏅', 'info');
        };

        // --- GEMINI API ENTEGRASYONLARI ---

        /**
         * Verilen malzemelerle Gemini API kullanarak bir tarif oluşturur.
         * Oluşturulan tarifi uygulama durumuna kaydeder ve ekranda gösterir.
         */
        async function generateRecipeWithAI() {
            const ingredientsInput = document.getElementById('recipeIngredientsInput');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const aiGeneratedRecipeDiv = document.getElementById('aiGeneratedRecipe');

            // DOM elementlerinin varlığını kontrol et
            if (!ingredientsInput || !loadingIndicator || !aiGeneratedRecipeDiv) {
                console.error("Tarif oluşturma alanları bulunamadı.");
                showNotification('Tarif oluşturma alanları bulunamadı!', 'error');
                return;
            }

            const ingredients = ingredientsInput.value.trim();
            if (!ingredients) {
                showNotification('Lütfen malzemeleri girin!', 'error');
                return;
            }

            loadingIndicator.style.display = 'block'; // Yükleniyor göstergesini aç
            aiGeneratedRecipeDiv.innerHTML = ''; // Önceki tarifi temizle
            appState.aiGeneratedRecipe = null; // State'deki önceki tarifi temizle

            // Gemini API için prompt oluşturma
            const prompt = `Generate a recipe using the following ingredients: ${ingredients}. Provide the response in JSON format according to this schema, ensuring ingredient quantities are specific and realistic:
            {
              "recipeName": "string",
              "ingredients": [
                {
                  "item": "string",
                  "quantity": "string"
                }
              ],
              "instructions": [
                "string"
              ]
            }. Provide recipe names and instructions in Turkish.`;

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                
                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "recipeName": { "type": "STRING" },
                                "ingredients": {
                                    "type": "ARRAY",
                                    "items": {
                                        "type": "OBJECT",
                                        "properties": {
                                            "item": { "type": "STRING" },
                                            "quantity": { "type": "STRING" }
                                        }
                                    }
                                },
                                "instructions": {
                                    "type": "ARRAY",
                                    "items": { "type": "STRING" }
                                }
                            },
                            "propertyOrdering": ["recipeName", "ingredients", "instructions"]
                        }
                    }
                };

                // Canvas ortamı tarafından sağlanacak olan API anahtarı.
                // Bu anahtar otomatik olarak enjekte edilecektir.
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API Hatası:', errorData);
                    showNotification('Tarif oluşturulurken hata oluştu: ' + (errorData.error?.message || 'Bilinmeyen Hata'), 'error');
                    return;
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    
                    const jsonString = result.candidates[0].content.parts[0].text;
                    let generatedRecipe = null;
                    try {
                        generatedRecipe = JSON.parse(jsonString);
                    } catch (parseError) {
                        console.error("JSON ayrıştırma hatası:", parseError, "Ham metin:", jsonString);
                        showNotification('AI yanıtı çözümlenemedi. Lütfen tekrar deneyin.', 'error');
                        return;
                    }

                    // Uygulama durumunu güncelle ve yeniden render et
                    updateState({ aiGeneratedRecipe: generatedRecipe });
                    showNotification('Tarif başarıyla oluşturuldu! 🧑‍🍳', 'success');

                    // Yeni render döngüsünden sonra tarifin görünür olmasını sağla
                    // renderChef() zaten çağrıldığı için bu satıra gerek kalmayabilir,
                    // ancak doğrudan element içeriğini güncellemeyi de düşünebiliriz.
                    // Şimdilik renderChef() içindeki conditional rendering'e güveniyoruz.
                } else {
                    showNotification('AI tarif oluşturamadı. Daha fazla bilgi sağlamayı deneyin.', 'info');
                }

            } catch (error) {
                console.error('Fetch hatası:', error);
                showNotification('Ağ hatası veya API erişim sorunu: ' + error.message, 'error');
            } finally {
                loadingIndicator.style.display = 'none'; // Yükleniyor göstergesini kapat
            }
        }

        /**
         * AI tarafından oluşturulan tarifteki malzemeleri alışveriş listesine ekler.
         */
        function addRecipeIngredientsToList() {
            if (!appState.aiGeneratedRecipe || !appState.aiGeneratedRecipe.ingredients) {
                showNotification('Eklenilecek tarif malzemesi bulunamadı!', 'error');
                return;
            }

            const newItems = [];
            appState.aiGeneratedRecipe.ingredients.forEach(item => {
                const emoji = getItemEmoji(item.item);
                // Miktarı ve birimi ayıklamaya çalış (örn: "2 adet" -> 2, "adet")
                const quantityParts = item.quantity.match(/(\d+\.?\d*)\s*(\S*)/);
                let quantityValue = '1';
                let unitValue = 'adet';

                if (quantityParts && quantityParts[1]) {
                    quantityValue = quantityParts[1];
                    unitValue = quantityParts[2] || 'adet'; // Birim boşsa 'adet' kullan
                } else {
                    // Eğer API'den gelen miktar sadece birim içeriyorsa veya sayı yoksa
                    unitValue = item.quantity;
                    quantityValue = '1'; // Varsayılan miktar
                }

                const newItem = {
                    id: Date.now() + Math.random(),
                    name: item.item,
                    quantity: `${quantityValue} ${unitValue}`.trim(), // Formatı koru
                    displayName: `${item.item} (${quantityValue} ${unitValue})`.trim(),
                    emoji: emoji,
                    completed: false,
                    completedBy: null,
                    addedBy: appState.user?.name || 'AI Aşçı',
                    category: categorizeItem(item.item),
                    addedAt: new Date().toLocaleString('tr-TR')
                };
                newItems.push(newItem);
            });

            const updatedShoppingList = [...appState.shoppingList, ...newItems];
            updateState({
                shoppingList: updatedShoppingList,
                aiGeneratedRecipe: null, // Malzemeler eklendikten sonra tarifi temizle
                currentPage: 'home' // Ana sayfaya geri dön
            });
            showNotification(`${newItems.length} tarif malzemesi ana sayfaya eklendi! 🛒`, 'success');
        }

        // --- GLOBAL WINDOW OBJEKTİNE EKLEMELER ---
        window.generateQRCode = generateQRCode;
        window.startVoiceRecognition = startVoiceRecognition;
        window.selectSuggestion = selectSuggestion;
        window.showSuggestions = showSuggestions;
        window.generateRecipeWithAI = generateRecipeWithAI; // Yeni eklenen fonksiyon
        window.addRecipeIngredientsToList = addRecipeIngredientsToList; // Yeni eklenen fonksiyon

        window.handleLoginClick = function() {
            const input = document.getElementById('loginInput');
            if (input && input.value.trim()) {
                handleLogin(input.value.trim());
            } else {
                showNotification('Lütfen geçerli bir kullanıcı adı girin!', 'error');
            }
        };
        
        window.addNewItem = function() {
            const nameInput = document.getElementById('newItemInput');
            const quantityInput = document.getElementById('newQuantityInput');
            const unitSelect = document.getElementById('newUnitSelect');
            
            if (nameInput && nameInput.value.trim()) {
                const name = nameInput.value.trim();
                const quantity = quantityInput ? quantityInput.value : '1';
                const unit = unitSelect ? unitSelect.value : 'adet';
                addItem(name, quantity, unit);
            } else {
                showNotification('Lütfen ürün adı girin!', 'error');
            }
        };

        window.handleAiQueryClick = function() {
            const input = document.getElementById('aiQueryInput');
            if (input) {
                updateState({ aiQuery: input.value });
                handleAiQuery();
            }
        };

        window.updateChefName = function() {
            const input = document.getElementById('chefNameInput');
            if (input && input.value.trim()) {
                updateState({ chefName: input.value.trim() });
                showNotification(`Aşçınızın adı "${input.value.trim()}" olarak güncellendi! 👨‍🍳`);
            } else {
                showNotification('Lütfen aşçı adı girin!', 'error');
            }
        };

        window.changePage = function(page) {
            updateState({ currentPage: page });
        };

        window.toggleItemComplete = toggleItemComplete;
        window.deleteItemFromList = deleteItemFromList;
        window.addAiSuggestionsToList = addAiSuggestionsToList;
    
        window.toggleDarkModeFunction = toggleDarkModeFunction;
        window.toggleSetting = toggleSetting;

        window.clearAllDataConfirm = function() {
            confirmAction('Tüm verileriniz kalıcı olarak silinecektir. Bu işlemi yapmak istediğinizden emin misiniz?', function() {
                localStorage.clear();
                location.reload();
            });
        };

        window.logout = function() {
            confirmAction('Hesabınızdan çıkış yapmak istediğinizden emin misiniz?', function() {
                localStorage.clear();
                location.reload();
            });
        };

        // Render function - Uygulamanın HTML içeriğini günceller
        function render() {
            const app = document.getElementById('app');
            if (!app) {
                console.error("App container not found!");
                return;
            }

            if (!appState.user) {
                app.innerHTML = renderLogin();
            } else {
                switch (appState.currentPage) {
                    case 'home':
                        app.innerHTML = renderHome();
                        break;
                    case 'chef':
                        app.innerHTML = renderChef();
                        break;
                    case 'settings':
                        app.innerHTML = renderSettings();
                        break;
                    default:
                        app.innerHTML = renderHome();
                }
            }

            // Ayarları uygula
            if (appState.settings.darkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
            document.body.classList.toggle('high-contrast', appState.settings.highContrast);
            document.body.classList.toggle('large-text', appState.settings.largeText);
        }

        // Initialize app
        // window.onload yerine DOMContentLoaded kullanmak daha güvenlidir.
        document.addEventListener('DOMContentLoaded', () => {
            render();
            syncWithOtherTabs();
            // Eğer URL'de bir paylaşım kodu varsa, otomatik olarak listeye katıl
            const urlParams = new URLSearchParams(window.location.search);
            const shareCodeFromUrl = urlParams.get('shareCode');
            if (shareCodeFromUrl && !appState.shareCode && appState.user) {
                // Sadece kullanıcı varsa otomatik katılmayı dene
                joinSharedList(shareCodeFromUrl.toUpperCase());
                // URL'deki shareCode'u temizle
                history.replaceState({}, document.title, window.location.pathname);
            }
        });
    </script>
</body>
</html>
�
